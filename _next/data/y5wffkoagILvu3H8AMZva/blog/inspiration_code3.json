{"pageProps":{"post":{"slug":"inspiration_code3","title":"Inspiration Code - part 3","description":"Code I wrote after reading a book - third part","date":"2011-12-29T00:00:01.000Z","content":"<h1>Inspiration Code</h1>\n<h2>Part 3</h2>\n<p>The last of these three parts summary is about <code>_thread</code> and <code>Result</code> structures.</p>\n<p><code>_thread</code> is a just a container for <code>pthread_t</code> and <code>pthread_attr_t</code> thread variables. It provides a wrapper for pthread_create and pthread_detach functions, and a member variable for storing the called function return value… However the most important task accomplished by this structure is reference counting.</p>\n<pre><code class=\"hljs language-arduino\"><span class=\"hljs-keyword\">template</span> &#x3C;<span class=\"hljs-keyword\">typename</span> T> <span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title class_\">_thread</span>\n{\n    <span class=\"hljs-comment\">// This struct will hold the return value of the thread called func.</span>\n\n    _thread() : <span class=\"hljs-built_in\">counter</span>(<span class=\"hljs-number\">0</span>)\n    {\n        <span class=\"hljs-built_in\">pthread_attr_init</span>(&#x26;attr);\n        <span class=\"hljs-built_in\">pthread_attr_setdetachstate</span>(&#x26;attr, PTHREAD_CREATE_JOINABLE);\n    }\n\n    ~_thread() { <span class=\"hljs-built_in\">pthread_detach</span>(thd); }\n\n    T result;\n    <span class=\"hljs-type\">pthread_t</span> thd;\n    <span class=\"hljs-type\">pthread_attr_t</span> attr;\n    <span class=\"hljs-keyword\">volatile</span> <span class=\"hljs-type\">int</span> counter;\n\n    <span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">join</span><span class=\"hljs-params\">()</span> </span>{ <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">pthread_join</span>(thd, <span class=\"hljs-literal\">NULL</span>); }\n    <span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">start</span><span class=\"hljs-params\">(<span class=\"hljs-type\">void</span>*(f)(<span class=\"hljs-type\">void</span>*), <span class=\"hljs-type\">void</span>* v)</span>\n    </span>{\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">pthread_create</span>(&#x26;thd, &#x26;attr, f, v);\n    }\n\n    <span class=\"hljs-comment\">// Atomic function for add and sub</span>\n    <span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">inc</span><span class=\"hljs-params\">()</span> </span>{ <span class=\"hljs-keyword\">return</span> __sync_fetch_and_add(&#x26;counter, <span class=\"hljs-number\">1</span>); }\n    <span class=\"hljs-function\"><span class=\"hljs-type\">int</span> <span class=\"hljs-title\">dec</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">if</span> (__sync_fetch_and_sub(&#x26;counter, <span class=\"hljs-number\">1</span>) == <span class=\"hljs-number\">0</span>)\n            <span class=\"hljs-keyword\">delete</span> <span class=\"hljs-keyword\">this</span>;\n        <span class=\"hljs-keyword\">return</span> counter;\n    }\n\n    <span class=\"hljs-keyword\">private</span>:\n    _thread(<span class=\"hljs-type\">const</span> _thread&#x26;);\n    _thread&#x26; <span class=\"hljs-keyword\">operator</span>=(<span class=\"hljs-type\">const</span> _thread&#x26;);\n};\n</code></pre>\n<p><code>_thread</code> has both inc/dec member functions that are called everytime the structure instance is referenced/dereferenced by some other object. When the dec member function is called and the counter becomes zero, then the destructor is invoked and <code>_thread</code> is deleted. Also, the destructor calls <code>pthread_detach</code>, so that thread’s resources can be freed.</p>\n<p>This reference counting mechanism is very important since we want that <code>_help_fn</code> and <code>_help_st</code> saves the computation results in a place from which we can fetch the result…</p>\n<p>To clarify: we can’t just launch the thread (that executes <code>_help_fn</code>), save the results and delete everything. We need to be sure that we are deleting the result at the right time.</p>\n<p>This is why, when a new thread is created, the corresponding <code>_thread</code> object is referenced both by a <code>_help_st</code> and a <code>Result</code> object. In this way, at the end of <code>_help_fn</code>, when <code>_help_st</code> is deleted, the dec function of <code>_thread</code> object is called by <code>_help_st</code> destructor…\nBut <code>_thread</code> object is deleted only if also the corresponding <code>Result</code> object is already deleted.</p>\n<pre><code class=\"hljs language-scss\">template &#x3C;typename T> struct Result\n{\n\n    <span class=\"hljs-built_in\">Result</span>(_thread&#x3C;T>* thd) : thd(thd)\n    {\n        thd-><span class=\"hljs-built_in\">inc</span>();\n    }\n\n    <span class=\"hljs-built_in\">Result</span>(const Result&#x3C;T>&#x26; o)\n    {\n        thd-><span class=\"hljs-built_in\">inc</span>();\n        thd = o<span class=\"hljs-selector-class\">.thd</span>;\n    }\n\n    Result&#x3C;T>&#x26; operator=(const Result&#x26; o)\n    {\n        o<span class=\"hljs-selector-class\">.thd-</span>><span class=\"hljs-built_in\">inc</span>();\n        thd-><span class=\"hljs-built_in\">dec</span>();\n        thd = o<span class=\"hljs-selector-class\">.thd</span>;\n        return *this;\n    }\n\n    T <span class=\"hljs-built_in\">value</span>()\n    {\n        switch (thd->join())\n        {\n            case <span class=\"hljs-number\">0</span>:\n              break;\n            case EINVAL:\n              throw std::runtime_error(<span class=\"hljs-string\">\"EINVAL on pthread_join\"</span>);\n              break;\n            case EDEADLK:\n              throw std::runtime_error(<span class=\"hljs-string\">\"EDEADLK on pthread_join\"</span>);\n              break;\n            case ESRCH:\n              // Thread already exited\n              break;\n        }\n        return thd->result;\n    }\n\n    ~<span class=\"hljs-built_in\">Result</span>()\n    {\n        thd-><span class=\"hljs-built_in\">dec</span>();\n    }\n\n    _thread&#x3C;T>* thd;\n}\n</code></pre>\n<p>The <code>Result</code> object is the one that is returned to the user who started a new thread. So, if the user keep it, he can fetch the return value through the <code>Result</code> object.\nOtherwise the <code>Result</code> object is automatically destroyed and corresponding <code>_thread</code> object is deleted when dec is called by <code>_help_st</code> destructor.</p>\n<p>To close this last part, here are the static methods of <code>Thread</code> class for creating a new thread that runs a function, a functor or an instance method having one argument. The signature is similar for functions, functors, and instance methods having more than one arument.\nAs you see the return value of these function is a <code>Result</code> object.</p>\n<pre><code class=\"hljs language-kotlin\">template &#x3C;typename T, typename O, typename I0> static Result&#x3C;T>\nrun(O obj, I0 a0)\n{\n    _functor1&#x3C;T, O, I0> o(obj, a0);\n    <span class=\"hljs-keyword\">return</span> Result&#x3C;T>(_start&#x3C;T>(o));\n}\n\ntemplate &#x3C;typename T, typename I0> static Result&#x3C;T>\nrun(T(*<span class=\"hljs-function\"><span class=\"hljs-keyword\">fun</span>)<span class=\"hljs-params\">(I0)</span></span>, I0 a0)\n{\n    _functor1&#x3C;T, T(*)(I0), I0> f(<span class=\"hljs-function\"><span class=\"hljs-keyword\">fun</span>, a0);</span>\n    <span class=\"hljs-keyword\">return</span> Result&#x3C;T>(_start&#x3C;T>(f));\n}\n\ntemplate &#x3C;typename T, typename C, typename I0> static Result&#x3C;T>\nrun(C* c, T(C::*<span class=\"hljs-function\"><span class=\"hljs-keyword\">fun</span>)<span class=\"hljs-params\">(I0)</span></span>, I0 a0)\n{\n    _class_functor1&#x3C;T, C, I0> f(c, <span class=\"hljs-function\"><span class=\"hljs-keyword\">fun</span>, a0);</span>\n    <span class=\"hljs-keyword\">return</span> Result&#x3C;T>(_start&#x3C;T>(f));\n}\n</code></pre>\n<p>Returning <code>Result</code> object is assigned a <code>_thread</code> object, created by <code>_start</code> helper function in <code>Thread</code> class.</p>\n<pre><code class=\"hljs language-r\">template <span class=\"hljs-operator\">&#x3C;</span>typename <span class=\"hljs-built_in\">T</span><span class=\"hljs-punctuation\">,</span> typename <span class=\"hljs-built_in\">F</span><span class=\"hljs-operator\">></span> static _thread<span class=\"hljs-operator\">&#x3C;</span><span class=\"hljs-built_in\">T</span><span class=\"hljs-operator\">></span><span class=\"hljs-operator\">*</span>\n_start<span class=\"hljs-punctuation\">(</span>const <span class=\"hljs-built_in\">F</span><span class=\"hljs-operator\">&#x26;</span> functor<span class=\"hljs-punctuation\">)</span>\n<span class=\"hljs-punctuation\">{</span>\n    _thread<span class=\"hljs-operator\">&#x3C;</span><span class=\"hljs-built_in\">T</span><span class=\"hljs-operator\">></span><span class=\"hljs-operator\">*</span> mythread <span class=\"hljs-operator\">=</span> new _thread<span class=\"hljs-operator\">&#x3C;</span><span class=\"hljs-built_in\">T</span><span class=\"hljs-operator\">></span><span class=\"hljs-punctuation\">(</span><span class=\"hljs-punctuation\">)</span>;\n    _help_st<span class=\"hljs-operator\">&#x3C;</span><span class=\"hljs-built_in\">T</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-built_in\">F</span> <span class=\"hljs-operator\">></span><span class=\"hljs-operator\">*</span> h2 <span class=\"hljs-operator\">=</span> new _help_st<span class=\"hljs-operator\">&#x3C;</span><span class=\"hljs-built_in\">T</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-built_in\">F</span><span class=\"hljs-operator\">></span><span class=\"hljs-punctuation\">(</span>mythread<span class=\"hljs-punctuation\">,</span> functor<span class=\"hljs-punctuation\">)</span>;\n    mythread<span class=\"hljs-operator\">-></span>start<span class=\"hljs-punctuation\">(</span>_help_fn<span class=\"hljs-operator\">&#x3C;</span>_help_st<span class=\"hljs-operator\">&#x3C;</span><span class=\"hljs-built_in\">T</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-built_in\">F</span><span class=\"hljs-operator\">></span> <span class=\"hljs-operator\">></span><span class=\"hljs-punctuation\">,</span> h2<span class=\"hljs-punctuation\">)</span>;\n    <span class=\"hljs-built_in\">return</span> mythread;\n<span class=\"hljs-punctuation\">}</span>\n</code></pre>\n<p>I hope you enjoyed this post serie… If you have question or you need some clarification, just leave a comment. I will be happy to answer or rewrite the unclear part</p>\n<p><em>— 29/12/2011</em></p>"}},"__N_SSG":true}