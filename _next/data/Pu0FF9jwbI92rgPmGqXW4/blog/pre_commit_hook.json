{"pageProps":{"post":{"slug":"pre_commit_hook","title":"Pre-commit Hook","description":"Writing a commit hook for git","date":"2013-08-13T00:00:01.000Z","content":"<h1>Pre-commit Hook</h1>\n<p>The project on which I’m working has acquired some young people recently.</p>\n<p>For a couple of them it’s even their first working experience so I’m really\ntrying to transmit them the importance of conventions and an uniform coding style.</p>\n<p>It’s usual (and perfectly normal) to find some coding style mistakes in their commits.\nSo, to help us happily code all together, I created a small pre-commit hook\nto put in our repositories.</p>\n<p>Right now it’s just a simple no-tabs check, but with some small changes it could\ncheck for use of deprecated functions or some forgotten <code>import pdb; pdb.set_trace()</code> :)</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># Files extensions in hooks.notabs are separated by \"|\"</span>\n<span class=\"hljs-comment\"># Eg:</span>\n<span class=\"hljs-comment\">#   git config hooks.notabs py|js</span>\n\n<span class=\"hljs-built_in\">exec</span> 1>&#x26;2\nnotabs=$(git config hooks.notabs)\ntoplevel=$(<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"`git rev-parse --show-toplevel`/\"</span> | sed -e <span class=\"hljs-string\">'s/[\\/&#x26;]/\\\\&#x26;/g'</span>)\n<span class=\"hljs-keyword\">if</span> [ -n <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$notabs</span>\"</span> ] &#x26;&#x26;\n    git diff --cached -- not_a_file `git diff --cached --name-only |\n      egrep <span class=\"hljs-string\">'\\.('</span><span class=\"hljs-variable\">$notabs</span><span class=\"hljs-string\">')$'</span> |\n      sed <span class=\"hljs-string\">'s/^/'</span><span class=\"hljs-variable\">$toplevel</span><span class=\"hljs-string\">'/g'</span> | xargs` |\n      egrep -qn $<span class=\"hljs-string\">'^\\+\\.*\\t'</span>\n<span class=\"hljs-keyword\">then</span>\n    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Error: Attempt to add TABS\"</span>\n    <span class=\"hljs-built_in\">echo</span>\n    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Do you really want to break our beautiful coding conventions? :(\"</span>\n    <span class=\"hljs-built_in\">echo</span>\n    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Remove all tabs characters and stage again your changes.\"</span>\n    <span class=\"hljs-built_in\">echo</span>\n    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"To override this hook use:\"</span>\n    <span class=\"hljs-built_in\">echo</span>\n    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"  git commit --no-verify\"</span>\n    <span class=\"hljs-built_in\">echo</span>\n    <span class=\"hljs-built_in\">exit</span> 1\n<span class=\"hljs-keyword\">fi</span>\n</code></pre>\n<p>To have it working:</p>\n<p>copy this script into <code>repository_dir/.git/hooks/pre-commit</code>.\nAdd some file extensions to hooks.notabs variable (these must be separated by |).\nDone!</p>\n<p>Let’s look at each parts in rigorous order of execution</p>\n<ul>\n<li>\n<p><code>notabs=$(git config hooks.notabs)</code>: retrieves from local config the files extensions to check</p>\n</li>\n<li>\n<p><code>git diff --cached --name-only</code>: lists names of files that have staged changes</p>\n</li>\n<li>\n<p><code>egrep '\\.('$notabs')$'</code>: removes files having different extensions from the ones in notabs</p>\n</li>\n<li>\n<p><code>sed 's/^/'$toplevel'/g'</code>: prepend the absoulute path to each filename</p>\n</li>\n<li>\n<p><code>xargs</code>: creates a list of arguments using previous file names list</p>\n</li>\n<li>\n<p><code>git diff --cached -- not_a_file</code>: returns staged changes for files coming from “xargs”. Note that “not_a_file” is an unexistant file, specified in case that the output of xargs is empty. In fact if no files are specified the “git diff —cached” command would return staged changes for every file.</p>\n</li>\n<li>\n<p><code>egrep -qn '^\\+\\.*\\t'</code>: searches for all the lines starting with ”+” and containing a tab</p>\n</li>\n</ul>\n<p>Note that this pre-commit hook can be easily bypassed using.</p>\n<p><code>git commit --no-verify</code></p>\n<p>This reflects exactly the same thought I want communicate to my collegues. Everyone should\nstruggle to pass the pre-commit hook checks, but no one should be forced to.</p>\n<p>References:</p>\n<ol>\n<li><a href=\"http://git-scm.com/book/en/Customizing-Git-Git-Hooks\">Customizing-Git-Git-Hooks</a></li>\n</ol>\n<p><em>— 13/08/2013</em></p>"}},"__N_SSG":true}