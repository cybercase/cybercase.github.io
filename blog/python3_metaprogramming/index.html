<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Python 3 Metaprogramming</title><meta name="description" content="Experimenting with Python 3 Metaprogramming"/><meta property="og:title" content="Python 3 Metaprogramming"/><meta name="og:description" content="Experimenting with Python 3 Metaprogramming"/><meta property="og:url" content="https://stefano.brilli.me/blog/python3_metaprogramming/"/><meta property="og:type" content="website"/><meta name="next-head-count" content="8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="preconnect" href="https://cdnjs.cloudflare.com"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.3/katex.min.css" integrity="sha512-07YhC3P4/vS5HdgGuNAAeIxb5ee//efgRNo5AGdMtqFBUPYOdQG/sDK0Nl5qNq94kdEk/Pvu8pmN4GYUeucUkw==" crossorigin="anonymous" referrerPolicy="no-referrer"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/23b632ecbbf88eb8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/23b632ecbbf88eb8.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-5752944655d749a0.js" defer=""></script><script src="/_next/static/chunks/framework-a87821de553db91d.js" defer=""></script><script src="/_next/static/chunks/main-250a0b3dc1fc1f02.js" defer=""></script><script src="/_next/static/chunks/pages/_app-08f9979ebc4e297a.js" defer=""></script><script src="/_next/static/chunks/1bfc9850-b964ecc8fc6be6a1.js" defer=""></script><script src="/_next/static/chunks/440-9ab67ee21eaa4db8.js" defer=""></script><script src="/_next/static/chunks/294-5a7641993238b3cf.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-8674bd6fffbba048.js" defer=""></script><script src="/_next/static/c79P0UpIM2BLcn9egbI-A/_buildManifest.js" defer=""></script><script src="/_next/static/c79P0UpIM2BLcn9egbI-A/_ssgManifest.js" defer=""></script><script src="/_next/static/c79P0UpIM2BLcn9egbI-A/_middlewareManifest.js" defer=""></script><style data-emotion="css "></style><style data-href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap">@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc6CsI.woff) format('woff')}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc3CsTYl4BOQ3o.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc-CsTYl4BOQ3o.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc2CsTYl4BOQ3o.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc5CsTYl4BOQ3o.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc0CsTYl4BOQ3o.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc6CsTYl4BO.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style><style data-href="https://fonts.googleapis.com/css?family=Roboto:400,100italic,100,300,900&display=swap">@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEzAdKQ.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxIIzQ.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBBc-.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxM.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfBBc-.woff) format('woff')}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEz0dL-vwnYh2eg.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEzQdL-vwnYh2eg.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEzwdL-vwnYh2eg.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEzMdL-vwnYh2eg.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEz8dL-vwnYh2eg.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEz4dL-vwnYh2eg.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEzAdL-vwnYg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxFIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxMIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxEIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxLIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxHIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxGIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxIIzIXKMny.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fCRc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fABc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fCBc4AMP6lbBP.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fCxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fChc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBBc4AMP6lQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu72xKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu5mxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu7mxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu4WxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu7WxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu7GxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxKKTU1Kg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfCRc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfABc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfCBc4AMP6lbBP.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfBxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfCxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfChc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfBBc4AMP6lQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style><style data-href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,700&display=swap">@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZOf-Q.woff) format('woff')}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-fCZK.woff) format('woff')}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZWMf8.woff) format('woff')}@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZDf-LVrPHpBXw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZKf-LVrPHpBXw.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZBf-LVrPHpBXw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZAf-LVrPHpBXw.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZOf-LVrPHp.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-cSZMdeX3rsHo.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-eCZMdeX3rsHo.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-cyZMdeX3rsHo.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-ciZMdeX3rsHo.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-fCZMdeX3rg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZVcf6hPvhPUWH.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZXMf6hPvhPUWH.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZV8f6hPvhPUWH.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZVsf6hPvhPUWH.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZWMf6hPvhPQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><main class="container"><header class="site-header"><nav class="site-header-nav"><a href="/feed.rss" rel="alternate" type="application/rss+xml"><i class="fa fa-rss"></i></a><span></span><a href="/">Home</a><a href="/blog/">Blog</a></nav></header><article class="content blog-article" lang="en"><h1>Python 3 Metaprogramming</h1>
<p>How can you import XML files into Python 3?
And why you would?
… This blogpost doesn’t answer this last question, but it’s definetly going to answer the first one :)</p>
<p>Everything I’m writing is taken from this talk from David Beazley: <a href="https://www.youtube.com/watch?v=sPiWg5jSoZI">youtube video</a>.
Consider this post as a very little summary of its contents.</p>
<p>Let’s start with the requirements:
Python 3.3
… that’s all!</p>
<p>And let’s see what you’re getting:</p>
<p>If you define a file structures.xml like this</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">structures</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">structure</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Stock"</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">field</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"SizedString"</span> <span class="hljs-attr">maxlen</span>=<span class="hljs-string">"4"</span>></span>name<span class="hljs-tag">&#x3C;/<span class="hljs-name">field</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">field</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"PosInteger"</span>></span>shares<span class="hljs-tag">&#x3C;/<span class="hljs-name">field</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">field</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"PosFloat"</span>></span>price<span class="hljs-tag">&#x3C;/<span class="hljs-name">field</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">structure</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">structures</span>></span>
</span></code></pre>
<p>At the end of this blogpost you will get this</p>
<pre><code class="hljs language-python-repl"><span class="hljs-meta prompt_">>>></span> <span class="python"><span class="hljs-keyword">from</span> structures <span class="hljs-keyword">import</span> *</span>
<span class="hljs-meta prompt_">>>></span> <span class="python">s = Stock(<span class="hljs-string">"GOOG"</span>, <span class="hljs-number">100</span>, <span class="hljs-number">99.0</span>)</span>
<span class="hljs-meta prompt_">>>></span> <span class="python"><span class="hljs-comment"># DEFAULT INITIALIZER</span></span>
<span class="hljs-meta prompt_">>>></span> <span class="python">s.name, s.shares, s.price</span>
('GOOG', 1, 1.0)

<span class="hljs-meta prompt_">>>></span> <span class="python"><span class="hljs-comment"># TYPE CHECKING</span></span>
<span class="hljs-meta prompt_">>>></span> <span class="python">s.name = <span class="hljs-number">100</span></span>
TypeError: Expected &#x3C;class 'str'>

<span class="hljs-meta prompt_">>>></span> <span class="python"><span class="hljs-comment"># CONSTRAINT CHECKING</span></span>
<span class="hljs-meta prompt_">>>></span> <span class="python">s.name = <span class="hljs-string">"GOOOOOOG"</span></span>
ValueError: Too big
</code></pre>
<p>So, if this just aroused your curiosity, go on reading ;)</p>
<p>The first step is to have a look at descriptors.
Descriptors is just how properties are implemented in python [see this link]. In this example, we use them as classes to perform checks on values assignment.
So, let’s take as example a descriptor that performs a check such that only values of type str within a certain length are allowed.</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">StringDescriptor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, maxlen</span>):
        self.name = name
        self.maxlen = maxlen

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params">self, instance, value</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(value) != <span class="hljs-built_in">str</span>:
            <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">"Wrong type, expected: %s"</span> % <span class="hljs-built_in">str</span>(<span class="hljs-built_in">str</span>))
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(value) > self.maxlen:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"String too long"</span>)
        instance.__dict__[self.name] = value

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, instance, cls</span>):
        <span class="hljs-comment"># Actually performs the default action. Just don't define this</span>
        <span class="hljs-comment"># method to get the default behavior.</span>
        <span class="hljs-keyword">return</span> instance.__dict__[self.name]

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Stock</span>:
    name = StringDescriptor(<span class="hljs-string">"name"</span>, <span class="hljs-number">4</span>)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name</span>):
        self.name = name

<span class="hljs-meta">>>> </span>st = Stock(<span class="hljs-string">"GOOG"</span>)
<span class="hljs-meta">>>> </span>st.name = <span class="hljs-string">"GOOOOOG"</span>
Traceback (most recent call last):
  File <span class="hljs-string">"&#x3C;stdin>"</span>, line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span> &#x3C;module>
  File <span class="hljs-string">"post.py"</span>, line <span class="hljs-number">10</span>, <span class="hljs-keyword">in</span> __set__
    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"String too long"</span>)
ValueError: String too long

<span class="hljs-meta">>>> </span>st.name = <span class="hljs-number">1</span>

Traceback (most recent call last):
  File <span class="hljs-string">"&#x3C;stdin>"</span>, line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span> &#x3C;module>
  File <span class="hljs-string">"post.py"</span>, line <span class="hljs-number">8</span>, <span class="hljs-keyword">in</span> __set__
    <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">"Wrong type, expected: %s"</span> % <span class="hljs-built_in">str</span>(<span class="hljs-built_in">str</span>))
TypeError: Wrong <span class="hljs-built_in">type</span>, expected: &#x3C;<span class="hljs-keyword">class</span> <span class="hljs-string">'str'</span>>

To handle different descriptors, David uses a descriptors hierarchy like the following:
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Descriptor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name=<span class="hljs-literal">None</span></span>):
        self.name = name
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params">self, instance, value</span>):
        instance.__dict__[self.name] = value
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__delete__</span>(<span class="hljs-params">self, instance</span>):
        <span class="hljs-keyword">raise</span> AttributeError(<span class="hljs-string">"Can't delete"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Typed</span>(<span class="hljs-title class_ inherited__">Descriptor</span>):
    ty = <span class="hljs-built_in">object</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params">self, instance, value</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(value, self.ty):
            <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">'Expected %s'</span> % self.ty)
        <span class="hljs-built_in">super</span>().__set__(instance, value)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Sized</span>(<span class="hljs-title class_ inherited__">Descriptor</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args, maxlen, **kwargs</span>):
        self.maxlen = maxlen
        <span class="hljs-built_in">super</span>().__init__(*args, **kwargs)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params">self, instance, value</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) > self.maxlen:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">'Too big'</span>)
        <span class="hljs-built_in">super</span>().__set__(instance, value)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">String</span>(<span class="hljs-title class_ inherited__">Typed</span>):
    ty = <span class="hljs-built_in">str</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Integer</span>(<span class="hljs-title class_ inherited__">Typed</span>):
    ty = <span class="hljs-built_in">int</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Float</span>(<span class="hljs-title class_ inherited__">Typed</span>):
    ty = <span class="hljs-built_in">float</span>
</code></pre>
<p>Then merges the descriptors using multiple inheritance… But pay attention at MRO! (method resolution order)</p>
<pre><code class="hljs language-ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Positive</span>(Descriptor):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, instance, value</span>):
        <span class="hljs-keyword">if</span> value &#x3C; <span class="hljs-number">0</span>:
            raise ValueError(<span class="hljs-string">'Expected >= 0'</span>)
        <span class="hljs-variable language_">super</span>().__set__(instance, value)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PosInteger</span>(Integer, Positive):
    pass

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PosFloat</span>(Float, Positive):
    pass
</code></pre>
<p>Finally to get rid of the repeated variable’s name in the descriptor constructor, David use a metaclass to inject the name into the descriptor:</p>
<pre><code class="hljs language-ini">class StructMeta(type):
    def __new__(cls, name, bases, clsdict):
        <span class="hljs-attr">fields</span> = [ key for key, val in clsdict.items()
                if isinstance(val, Descriptor) ]
        for name in fields:
            clsdict<span class="hljs-section">[name]</span>.<span class="hljs-attr">name</span> = name
        <span class="hljs-attr">clsobj</span> = super().__new__(cls, name, bases, clsdict)
        return clsobj
</code></pre>
<p>The Stock class definition now becomes</p>
<pre><code class="hljs language-ini">class Stock(<span class="hljs-attr">metaclass</span>=StructMeta):
    <span class="hljs-attr">name</span> = SizedString(maxlen=<span class="hljs-number">4</span>)
    <span class="hljs-attr">shares</span> = PosInteger()
    <span class="hljs-attr">price</span> = PosFloat()

    def __init__(self, name, shares, price):
        <span class="hljs-attr">self.name</span> = name
        <span class="hljs-attr">self.shares</span> = shares
        <span class="hljs-attr">self.price</span> = price
</code></pre>
<p>There is still another “problem” that David try to solve: the code repetition inside the <strong>init</strong> method.
To address this problem, he changes the previous metaclass as follows.
from collections import OrderedDict</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">StructMeta</span>(<span class="hljs-title class_ inherited__">type</span>):
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__prepare__</span>(<span class="hljs-params">cls, name, bases=<span class="hljs-literal">None</span></span>):
        <span class="hljs-comment"># this method returns the dictionary used by the class instance.</span>
        <span class="hljs-comment"># To generate a signature the parameters order is crucial, so an</span>
        <span class="hljs-comment"># OrderedDict is used</span>
        <span class="hljs-keyword">return</span> OrderedDict()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, name, bases, clsdict</span>):
        fields = [ key <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">in</span> clsdict.items()
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(val, Descriptor) ]
        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> fields:
            clsdict[name].name = name

        <span class="hljs-comment"># the following block generates the code for __init__ method</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(fields):
            init_code = <span class="hljs-string">'def __init__(self, %s):\n'</span> % \
                        <span class="hljs-string">', '</span>.join(fields)
            <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> fields:
                init_code += <span class="hljs-string">'    self.%s = %s\n'</span> % (name, name)
            <span class="hljs-built_in">exec</span>(init_code, <span class="hljs-built_in">globals</span>(), clsdict)

        clsobj = <span class="hljs-built_in">super</span>().__new__(cls, name, bases, <span class="hljs-built_in">dict</span>(clsdict))
        <span class="hljs-keyword">return</span> clsobj
</code></pre>
<p>And the Stock class becomes</p>
<pre><code class="hljs language-ini">class Stock(<span class="hljs-attr">metaclass</span>=StructMeta):
    <span class="hljs-attr">name</span> = SizedString(maxlen=<span class="hljs-number">4</span>)
    <span class="hljs-attr">shares</span> = PosInteger()
    <span class="hljs-attr">price</span> = PosFloat()
</code></pre>
<p>At this point it’s convenient introduce a Structure base class:</p>
<pre><code class="hljs language-ini">class Structure(<span class="hljs-attr">metaclass</span>=StructMeta):
    pass

class Stock(Structure):
    <span class="hljs-attr">name</span> = SizedString(maxlen=<span class="hljs-number">4</span>)
    <span class="hljs-attr">shares</span> = PosInteger()
    <span class="hljs-attr">price</span> = PosFloat()
</code></pre>
<p>And finally we get to the XML part :)
The first goal is to generate the python code from the XML file. To achieve this the David use these functions:</p>
<pre><code class="hljs language-css"><span class="hljs-selector-tag">from</span> xml<span class="hljs-selector-class">.etree</span><span class="hljs-selector-class">.ElementTree</span> import parse
def _xml_to_code(filename):
    doc = <span class="hljs-built_in">parse</span>(filename)
    code = <span class="hljs-string">''</span>
    for st in doc.<span class="hljs-built_in">findall</span>(<span class="hljs-string">'structure'</span>):
        code += <span class="hljs-built_in">_xml_struct_code</span>(st)
    return code

def <span class="hljs-built_in">_xml_struct_code</span>(st):
    stname = st.<span class="hljs-built_in">get</span>(<span class="hljs-string">'name'</span>)
    code = <span class="hljs-string">'class %s(Structure):\n'</span> % stname
    for field in st.<span class="hljs-built_in">findall</span>(<span class="hljs-string">'field'</span>):
        name = field.text.<span class="hljs-built_in">strip</span>()
        dtype = field.<span class="hljs-built_in">get</span>(<span class="hljs-string">'type'</span>)
        kwargs = <span class="hljs-string">', '</span>.<span class="hljs-built_in">join</span>(<span class="hljs-string">'%s=%s'</span> % (key, val)
                            for key, val in field.<span class="hljs-built_in">items</span>()
                            if key != <span class="hljs-string">'type'</span>)
        code += <span class="hljs-string">'    %s = %s(%s)\n'</span> % (name, dtype, kwargs)
    return code
</code></pre>
<p>And the result of parsing the structure.xml file (defined at the beginning of the blogpost) is:</p>
<pre><code class="hljs language-ini">>>> print(_xml_to_code("structures.xml"))
class Stock(Structure):
    <span class="hljs-attr">name</span> = SizedString(maxlen=<span class="hljs-number">4</span>)
    <span class="hljs-attr">shares</span> = PosInteger()
    <span class="hljs-attr">price</span> = PosFloat()
</code></pre>
<p>The final step consists in hooking to the python import system. Full details about the new Import Hooks feature of Python3.3 are found at [PEP-302].
We begin defining a new importer class to append at sys.meta_path</p>
<pre><code class="hljs language-lua">import <span class="hljs-built_in">os</span>
class StructImporter:
    def __init__(<span class="hljs-built_in">self</span>, <span class="hljs-built_in">path</span>):
        <span class="hljs-built_in">self</span>._path = <span class="hljs-built_in">path</span>
    def find_module(<span class="hljs-built_in">self</span>, fullname, <span class="hljs-built_in">path</span>=None):
        name = fullname.rpartition(<span class="hljs-string">'.'</span>)[<span class="hljs-number">-1</span>]
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">path</span> is None:
            <span class="hljs-built_in">path</span> = <span class="hljs-built_in">self</span>._path
        <span class="hljs-keyword">for</span> dn <span class="hljs-keyword">in</span> <span class="hljs-built_in">path</span>:
            filename = <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.join(dn, name+<span class="hljs-string">'.xml'</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.exists(filename):
                <span class="hljs-keyword">return</span> StructXMLLoader(filename)
        <span class="hljs-keyword">return</span> None
</code></pre>
<p>And an XML module loader</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">import</span> imp
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StructXMLLoader</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, filename</span>):
        self._filename = filename
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_module</span>(<span class="hljs-params">self, fullname</span>):
        mod = sys.modules.setdefault(fullname,
                                    imp.new_module(fullname))
        mod.__file__ = self._filename
        mod.__loader__ = self
        code = _xml_to_code(self._filename)
        <span class="hljs-comment"># actually this is bad. I should use mod.__dict__</span>
        <span class="hljs-comment"># instead of globals(), and add an import statement into</span>
        <span class="hljs-comment"># "code" to load Structure and the other classes.</span>
        <span class="hljs-built_in">exec</span>(code, <span class="hljs-built_in">globals</span>(), mod.__dict__)
        <span class="hljs-keyword">return</span> mod

<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">def</span> <span class="hljs-title function_">install_importer</span>(<span class="hljs-params">path=sys.path</span>):
    sys.meta_path.append(StructImporter(path))

install_importer()

And <span class="hljs-keyword">finally</span> here we are:
Python3<span class="hljs-number">.3</span> -i xmlimport.py
<span class="hljs-meta">>>> </span><span class="hljs-keyword">from</span> structures <span class="hljs-keyword">import</span> *
<span class="hljs-meta">>>> </span>s = Stock(<span class="hljs-string">"GOOG"</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1.0</span>)
</code></pre>
<p>You can find the final version of the xmlimporter.py and structures.xml under the folder</p>
<p><code>python_metaprogramming</code> in my git repository at:</p>
<p><code>git://github.com/cybercase/funproject.git</code></p>
<p>If you got 3 hours to spend, and a lot of love for this metaprogramming stuff, I really suggest to watch the entire video from David Beazley. Also, I apologize in advance for any error in this blogpost.</p>
<p><em>— 22/05/2013</em></p></article><footer class="footer"><div class="footer-contacts"><a href="https://twitter.com/thecybercase" target="_blank" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://github.com/cybercase" target="_blank" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a href="https://it.linkedin.com/pub/stefano-brilli/21/650/953" target="_blank" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a href="mailto:stefano@brilli.me"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a></div><div>© Stefano Brilli. All Rights Reserved.</div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"python3_metaprogramming","title":"Python 3 Metaprogramming","description":"Experimenting with Python 3 Metaprogramming","date":"2013-05-22T00:00:01.000Z","content":"\u003ch1\u003ePython 3 Metaprogramming\u003c/h1\u003e\n\u003cp\u003eHow can you import XML files into Python 3?\nAnd why you would?\n… This blogpost doesn’t answer this last question, but it’s definetly going to answer the first one :)\u003c/p\u003e\n\u003cp\u003eEverything I’m writing is taken from this talk from David Beazley: \u003ca href=\"https://www.youtube.com/watch?v=sPiWg5jSoZI\"\u003eyoutube video\u003c/a\u003e.\nConsider this post as a very little summary of its contents.\u003c/p\u003e\n\u003cp\u003eLet’s start with the requirements:\nPython 3.3\n… that’s all!\u003c/p\u003e\n\u003cp\u003eAnd let’s see what you’re getting:\u003c/p\u003e\n\u003cp\u003eIf you define a file structures.xml like this\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-php-template\"\u003e\u003cspan class=\"xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003estructures\u003c/span\u003e\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003estructure\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"Stock\"\u003c/span\u003e\u003e\u003c/span\u003e\n        \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003efield\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"SizedString\"\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003emaxlen\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"4\"\u003c/span\u003e\u003e\u003c/span\u003ename\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003efield\u003c/span\u003e\u003e\u003c/span\u003e\n        \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003efield\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"PosInteger\"\u003c/span\u003e\u003e\u003c/span\u003eshares\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003efield\u003c/span\u003e\u003e\u003c/span\u003e\n        \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003efield\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"PosFloat\"\u003c/span\u003e\u003e\u003c/span\u003eprice\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003efield\u003c/span\u003e\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003estructure\u003c/span\u003e\u003e\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003estructures\u003c/span\u003e\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAt the end of this blogpost you will get this\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python-repl\"\u003e\u003cspan class=\"hljs-meta prompt_\"\u003e\u003e\u003e\u003e\u003c/span\u003e \u003cspan class=\"python\"\u003e\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e structures \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e *\u003c/span\u003e\n\u003cspan class=\"hljs-meta prompt_\"\u003e\u003e\u003e\u003e\u003c/span\u003e \u003cspan class=\"python\"\u003es = Stock(\u003cspan class=\"hljs-string\"\u003e\"GOOG\"\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e99.0\u003c/span\u003e)\u003c/span\u003e\n\u003cspan class=\"hljs-meta prompt_\"\u003e\u003e\u003e\u003e\u003c/span\u003e \u003cspan class=\"python\"\u003e\u003cspan class=\"hljs-comment\"\u003e# DEFAULT INITIALIZER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"hljs-meta prompt_\"\u003e\u003e\u003e\u003e\u003c/span\u003e \u003cspan class=\"python\"\u003es.name, s.shares, s.price\u003c/span\u003e\n('GOOG', 1, 1.0)\n\n\u003cspan class=\"hljs-meta prompt_\"\u003e\u003e\u003e\u003e\u003c/span\u003e \u003cspan class=\"python\"\u003e\u003cspan class=\"hljs-comment\"\u003e# TYPE CHECKING\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"hljs-meta prompt_\"\u003e\u003e\u003e\u003e\u003c/span\u003e \u003cspan class=\"python\"\u003es.name = \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e\u003c/span\u003e\nTypeError: Expected \u0026#x3C;class 'str'\u003e\n\n\u003cspan class=\"hljs-meta prompt_\"\u003e\u003e\u003e\u003e\u003c/span\u003e \u003cspan class=\"python\"\u003e\u003cspan class=\"hljs-comment\"\u003e# CONSTRAINT CHECKING\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"hljs-meta prompt_\"\u003e\u003e\u003e\u003e\u003c/span\u003e \u003cspan class=\"python\"\u003es.name = \u003cspan class=\"hljs-string\"\u003e\"GOOOOOOG\"\u003c/span\u003e\u003c/span\u003e\nValueError: Too big\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo, if this just aroused your curiosity, go on reading ;)\u003c/p\u003e\n\u003cp\u003eThe first step is to have a look at descriptors.\nDescriptors is just how properties are implemented in python [see this link]. In this example, we use them as classes to perform checks on values assignment.\nSo, let’s take as example a descriptor that performs a check such that only values of type str within a certain length are allowed.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eStringDescriptor\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__init__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, name, maxlen\u003c/span\u003e):\n        self.name = name\n        self.maxlen = maxlen\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__set__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, instance, value\u003c/span\u003e):\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003etype\u003c/span\u003e(value) != \u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e:\n            \u003cspan class=\"hljs-keyword\"\u003eraise\u003c/span\u003e TypeError(\u003cspan class=\"hljs-string\"\u003e\"Wrong type, expected: %s\"\u003c/span\u003e % \u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e))\n        \u003cspan class=\"hljs-keyword\"\u003eelif\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003elen\u003c/span\u003e(value) \u003e self.maxlen:\n            \u003cspan class=\"hljs-keyword\"\u003eraise\u003c/span\u003e ValueError(\u003cspan class=\"hljs-string\"\u003e\"String too long\"\u003c/span\u003e)\n        instance.__dict__[self.name] = value\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__get__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, instance, cls\u003c/span\u003e):\n        \u003cspan class=\"hljs-comment\"\u003e# Actually performs the default action. Just don't define this\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e# method to get the default behavior.\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e instance.__dict__[self.name]\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eStock\u003c/span\u003e:\n    name = StringDescriptor(\u003cspan class=\"hljs-string\"\u003e\"name\"\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e)\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__init__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, name\u003c/span\u003e):\n        self.name = name\n\n\u003cspan class=\"hljs-meta\"\u003e\u003e\u003e\u003e \u003c/span\u003est = Stock(\u003cspan class=\"hljs-string\"\u003e\"GOOG\"\u003c/span\u003e)\n\u003cspan class=\"hljs-meta\"\u003e\u003e\u003e\u003e \u003c/span\u003est.name = \u003cspan class=\"hljs-string\"\u003e\"GOOOOOG\"\u003c/span\u003e\nTraceback (most recent call last):\n  File \u003cspan class=\"hljs-string\"\u003e\"\u0026#x3C;stdin\u003e\"\u003c/span\u003e, line \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e \u0026#x3C;module\u003e\n  File \u003cspan class=\"hljs-string\"\u003e\"post.py\"\u003c/span\u003e, line \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e __set__\n    \u003cspan class=\"hljs-keyword\"\u003eraise\u003c/span\u003e ValueError(\u003cspan class=\"hljs-string\"\u003e\"String too long\"\u003c/span\u003e)\nValueError: String too long\n\n\u003cspan class=\"hljs-meta\"\u003e\u003e\u003e\u003e \u003c/span\u003est.name = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n\nTraceback (most recent call last):\n  File \u003cspan class=\"hljs-string\"\u003e\"\u0026#x3C;stdin\u003e\"\u003c/span\u003e, line \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e \u0026#x3C;module\u003e\n  File \u003cspan class=\"hljs-string\"\u003e\"post.py\"\u003c/span\u003e, line \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e __set__\n    \u003cspan class=\"hljs-keyword\"\u003eraise\u003c/span\u003e TypeError(\u003cspan class=\"hljs-string\"\u003e\"Wrong type, expected: %s\"\u003c/span\u003e % \u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e))\nTypeError: Wrong \u003cspan class=\"hljs-built_in\"\u003etype\u003c/span\u003e, expected: \u0026#x3C;\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'str'\u003c/span\u003e\u003e\n\nTo handle different descriptors, David uses a descriptors hierarchy like the following:\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDescriptor\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__init__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, name=\u003cspan class=\"hljs-literal\"\u003eNone\u003c/span\u003e\u003c/span\u003e):\n        self.name = name\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__set__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, instance, value\u003c/span\u003e):\n        instance.__dict__[self.name] = value\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__delete__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, instance\u003c/span\u003e):\n        \u003cspan class=\"hljs-keyword\"\u003eraise\u003c/span\u003e AttributeError(\u003cspan class=\"hljs-string\"\u003e\"Can't delete\"\u003c/span\u003e)\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eTyped\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003eDescriptor\u003c/span\u003e):\n    ty = \u003cspan class=\"hljs-built_in\"\u003eobject\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__set__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, instance, value\u003c/span\u003e):\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enot\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eisinstance\u003c/span\u003e(value, self.ty):\n            \u003cspan class=\"hljs-keyword\"\u003eraise\u003c/span\u003e TypeError(\u003cspan class=\"hljs-string\"\u003e'Expected %s'\u003c/span\u003e % self.ty)\n        \u003cspan class=\"hljs-built_in\"\u003esuper\u003c/span\u003e().__set__(instance, value)\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSized\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003eDescriptor\u003c/span\u003e):\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__init__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, *args, maxlen, **kwargs\u003c/span\u003e):\n        self.maxlen = maxlen\n        \u003cspan class=\"hljs-built_in\"\u003esuper\u003c/span\u003e().__init__(*args, **kwargs)\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__set__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, instance, value\u003c/span\u003e):\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003elen\u003c/span\u003e(value) \u003e self.maxlen:\n            \u003cspan class=\"hljs-keyword\"\u003eraise\u003c/span\u003e ValueError(\u003cspan class=\"hljs-string\"\u003e'Too big'\u003c/span\u003e)\n        \u003cspan class=\"hljs-built_in\"\u003esuper\u003c/span\u003e().__set__(instance, value)\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003eTyped\u003c/span\u003e):\n    ty = \u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eInteger\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003eTyped\u003c/span\u003e):\n    ty = \u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFloat\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003eTyped\u003c/span\u003e):\n    ty = \u003cspan class=\"hljs-built_in\"\u003efloat\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen merges the descriptors using multiple inheritance… But pay attention at MRO! (method resolution order)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ruby\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePositive\u003c/span\u003e(Descriptor):\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__set__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-variable language_\"\u003eself\u003c/span\u003e, instance, value\u003c/span\u003e):\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e value \u0026#x3C; \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e:\n            raise ValueError(\u003cspan class=\"hljs-string\"\u003e'Expected \u003e= 0'\u003c/span\u003e)\n        \u003cspan class=\"hljs-variable language_\"\u003esuper\u003c/span\u003e().__set__(instance, value)\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePosInteger\u003c/span\u003e(Integer, Positive):\n    pass\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePosFloat\u003c/span\u003e(Float, Positive):\n    pass\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFinally to get rid of the repeated variable’s name in the descriptor constructor, David use a metaclass to inject the name into the descriptor:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003eclass StructMeta(type):\n    def __new__(cls, name, bases, clsdict):\n        \u003cspan class=\"hljs-attr\"\u003efields\u003c/span\u003e = [ key for key, val in clsdict.items()\n                if isinstance(val, Descriptor) ]\n        for name in fields:\n            clsdict\u003cspan class=\"hljs-section\"\u003e[name]\u003c/span\u003e.\u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e = name\n        \u003cspan class=\"hljs-attr\"\u003eclsobj\u003c/span\u003e = super().__new__(cls, name, bases, clsdict)\n        return clsobj\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe Stock class definition now becomes\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003eclass Stock(\u003cspan class=\"hljs-attr\"\u003emetaclass\u003c/span\u003e=StructMeta):\n    \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e = SizedString(maxlen=\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e)\n    \u003cspan class=\"hljs-attr\"\u003eshares\u003c/span\u003e = PosInteger()\n    \u003cspan class=\"hljs-attr\"\u003eprice\u003c/span\u003e = PosFloat()\n\n    def __init__(self, name, shares, price):\n        \u003cspan class=\"hljs-attr\"\u003eself.name\u003c/span\u003e = name\n        \u003cspan class=\"hljs-attr\"\u003eself.shares\u003c/span\u003e = shares\n        \u003cspan class=\"hljs-attr\"\u003eself.price\u003c/span\u003e = price\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThere is still another “problem” that David try to solve: the code repetition inside the \u003cstrong\u003einit\u003c/strong\u003e method.\nTo address this problem, he changes the previous metaclass as follows.\nfrom collections import OrderedDict\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eStructMeta\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003etype\u003c/span\u003e):\n\u003cspan class=\"hljs-meta\"\u003e    @staticmethod\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__prepare__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ecls, name, bases=\u003cspan class=\"hljs-literal\"\u003eNone\u003c/span\u003e\u003c/span\u003e):\n        \u003cspan class=\"hljs-comment\"\u003e# this method returns the dictionary used by the class instance.\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e# To generate a signature the parameters order is crucial, so an\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e# OrderedDict is used\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e OrderedDict()\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__new__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ecls, name, bases, clsdict\u003c/span\u003e):\n        fields = [ key \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e key, val \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e clsdict.items()\n                \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eisinstance\u003c/span\u003e(val, Descriptor) ]\n        \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e name \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e fields:\n            clsdict[name].name = name\n\n        \u003cspan class=\"hljs-comment\"\u003e# the following block generates the code for __init__ method\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003elen\u003c/span\u003e(fields):\n            init_code = \u003cspan class=\"hljs-string\"\u003e'def __init__(self, %s):\\n'\u003c/span\u003e % \\\n                        \u003cspan class=\"hljs-string\"\u003e', '\u003c/span\u003e.join(fields)\n            \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e name \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e fields:\n                init_code += \u003cspan class=\"hljs-string\"\u003e'    self.%s = %s\\n'\u003c/span\u003e % (name, name)\n            \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e(init_code, \u003cspan class=\"hljs-built_in\"\u003eglobals\u003c/span\u003e(), clsdict)\n\n        clsobj = \u003cspan class=\"hljs-built_in\"\u003esuper\u003c/span\u003e().__new__(cls, name, bases, \u003cspan class=\"hljs-built_in\"\u003edict\u003c/span\u003e(clsdict))\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e clsobj\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd the Stock class becomes\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003eclass Stock(\u003cspan class=\"hljs-attr\"\u003emetaclass\u003c/span\u003e=StructMeta):\n    \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e = SizedString(maxlen=\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e)\n    \u003cspan class=\"hljs-attr\"\u003eshares\u003c/span\u003e = PosInteger()\n    \u003cspan class=\"hljs-attr\"\u003eprice\u003c/span\u003e = PosFloat()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAt this point it’s convenient introduce a Structure base class:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003eclass Structure(\u003cspan class=\"hljs-attr\"\u003emetaclass\u003c/span\u003e=StructMeta):\n    pass\n\nclass Stock(Structure):\n    \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e = SizedString(maxlen=\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e)\n    \u003cspan class=\"hljs-attr\"\u003eshares\u003c/span\u003e = PosInteger()\n    \u003cspan class=\"hljs-attr\"\u003eprice\u003c/span\u003e = PosFloat()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd finally we get to the XML part :)\nThe first goal is to generate the python code from the XML file. To achieve this the David use these functions:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-css\"\u003e\u003cspan class=\"hljs-selector-tag\"\u003efrom\u003c/span\u003e xml\u003cspan class=\"hljs-selector-class\"\u003e.etree\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.ElementTree\u003c/span\u003e import parse\ndef _xml_to_code(filename):\n    doc = \u003cspan class=\"hljs-built_in\"\u003eparse\u003c/span\u003e(filename)\n    code = \u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e\n    for st in doc.\u003cspan class=\"hljs-built_in\"\u003efindall\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'structure'\u003c/span\u003e):\n        code += \u003cspan class=\"hljs-built_in\"\u003e_xml_struct_code\u003c/span\u003e(st)\n    return code\n\ndef \u003cspan class=\"hljs-built_in\"\u003e_xml_struct_code\u003c/span\u003e(st):\n    stname = st.\u003cspan class=\"hljs-built_in\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e)\n    code = \u003cspan class=\"hljs-string\"\u003e'class %s(Structure):\\n'\u003c/span\u003e % stname\n    for field in st.\u003cspan class=\"hljs-built_in\"\u003efindall\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'field'\u003c/span\u003e):\n        name = field.text.\u003cspan class=\"hljs-built_in\"\u003estrip\u003c/span\u003e()\n        dtype = field.\u003cspan class=\"hljs-built_in\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'type'\u003c/span\u003e)\n        kwargs = \u003cspan class=\"hljs-string\"\u003e', '\u003c/span\u003e.\u003cspan class=\"hljs-built_in\"\u003ejoin\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'%s=%s'\u003c/span\u003e % (key, val)\n                            for key, val in field.\u003cspan class=\"hljs-built_in\"\u003eitems\u003c/span\u003e()\n                            if key != \u003cspan class=\"hljs-string\"\u003e'type'\u003c/span\u003e)\n        code += \u003cspan class=\"hljs-string\"\u003e'    %s = %s(%s)\\n'\u003c/span\u003e % (name, dtype, kwargs)\n    return code\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd the result of parsing the structure.xml file (defined at the beginning of the blogpost) is:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e\u003e\u003e\u003e print(_xml_to_code(\"structures.xml\"))\nclass Stock(Structure):\n    \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e = SizedString(maxlen=\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e)\n    \u003cspan class=\"hljs-attr\"\u003eshares\u003c/span\u003e = PosInteger()\n    \u003cspan class=\"hljs-attr\"\u003eprice\u003c/span\u003e = PosFloat()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe final step consists in hooking to the python import system. Full details about the new Import Hooks feature of Python3.3 are found at [PEP-302].\nWe begin defining a new importer class to append at sys.meta_path\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-lua\"\u003eimport \u003cspan class=\"hljs-built_in\"\u003eos\u003c/span\u003e\nclass StructImporter:\n    def __init__(\u003cspan class=\"hljs-built_in\"\u003eself\u003c/span\u003e, \u003cspan class=\"hljs-built_in\"\u003epath\u003c/span\u003e):\n        \u003cspan class=\"hljs-built_in\"\u003eself\u003c/span\u003e._path = \u003cspan class=\"hljs-built_in\"\u003epath\u003c/span\u003e\n    def find_module(\u003cspan class=\"hljs-built_in\"\u003eself\u003c/span\u003e, fullname, \u003cspan class=\"hljs-built_in\"\u003epath\u003c/span\u003e=None):\n        name = fullname.rpartition(\u003cspan class=\"hljs-string\"\u003e'.'\u003c/span\u003e)[\u003cspan class=\"hljs-number\"\u003e-1\u003c/span\u003e]\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003epath\u003c/span\u003e is None:\n            \u003cspan class=\"hljs-built_in\"\u003epath\u003c/span\u003e = \u003cspan class=\"hljs-built_in\"\u003eself\u003c/span\u003e._path\n        \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e dn \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003epath\u003c/span\u003e:\n            filename = \u003cspan class=\"hljs-built_in\"\u003eos\u003c/span\u003e.\u003cspan class=\"hljs-built_in\"\u003epath\u003c/span\u003e.join(dn, name+\u003cspan class=\"hljs-string\"\u003e'.xml'\u003c/span\u003e)\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eos\u003c/span\u003e.\u003cspan class=\"hljs-built_in\"\u003epath\u003c/span\u003e.exists(filename):\n                \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e StructXMLLoader(filename)\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e None\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd an XML module loader\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e imp\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eStructXMLLoader\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__init__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, filename\u003c/span\u003e):\n        self._filename = filename\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eload_module\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, fullname\u003c/span\u003e):\n        mod = sys.modules.setdefault(fullname,\n                                    imp.new_module(fullname))\n        mod.__file__ = self._filename\n        mod.__loader__ = self\n        code = _xml_to_code(self._filename)\n        \u003cspan class=\"hljs-comment\"\u003e# actually this is bad. I should use mod.__dict__\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e# instead of globals(), and add an import statement into\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e# \"code\" to load Structure and the other classes.\u003c/span\u003e\n        \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e(code, \u003cspan class=\"hljs-built_in\"\u003eglobals\u003c/span\u003e(), mod.__dict__)\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e mod\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e sys\n\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003einstall_importer\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003epath=sys.path\u003c/span\u003e):\n    sys.meta_path.append(StructImporter(path))\n\ninstall_importer()\n\nAnd \u003cspan class=\"hljs-keyword\"\u003efinally\u003c/span\u003e here we are:\nPython3\u003cspan class=\"hljs-number\"\u003e.3\u003c/span\u003e -i xmlimport.py\n\u003cspan class=\"hljs-meta\"\u003e\u003e\u003e\u003e \u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e structures \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e *\n\u003cspan class=\"hljs-meta\"\u003e\u003e\u003e\u003e \u003c/span\u003es = Stock(\u003cspan class=\"hljs-string\"\u003e\"GOOG\"\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1.0\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can find the final version of the xmlimporter.py and structures.xml under the folder\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003epython_metaprogramming\u003c/code\u003e in my git repository at:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003egit://github.com/cybercase/funproject.git\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eIf you got 3 hours to spend, and a lot of love for this metaprogramming stuff, I really suggest to watch the entire video from David Beazley. Also, I apologize in advance for any error in this blogpost.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e— 22/05/2013\u003c/em\u003e\u003c/p\u003e"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"python3_metaprogramming"},"buildId":"c79P0UpIM2BLcn9egbI-A","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>