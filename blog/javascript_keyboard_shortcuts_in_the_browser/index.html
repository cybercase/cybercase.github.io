<!doctype html><html lang=""><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Defining layout independent keyboard shortcuts in the browser"><meta property="og:title" content="Keyboard Shortcuts and Layouts in the Browser"><meta property="og:site_name" content="Stefano Brilli Home Page"><meta property="og:type" content="article"><meta property="og:locale" content="en_US"><meta property="og:image" content="/images/keyboard.png"><meta property="article:author" content="Stefano Brilli"><title>Keyboard Shortcuts and Layouts in the Browser</title><link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto:400,100italic,100,300,900" rel="stylesheet" type="text/css"><link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="/styles/vendor-a3db57aa98.css"><link rel="stylesheet" href="/styles/main-5e2edbf30c.css"></head><body><div class="container"><header class="header header--cover header--dark"><div class="header-image" style="background-image: url(/images/keyboard.png)"><div class="header-image-box"><h1 class="header-image-title">Keyboard Shortcuts and Layouts in the Browser</h1></div></div><nav class="header-links"><div class="header-links-rss"><a href="/feed.rss" rel="alternate" type="application/rss+xml"><i class="fa fa-rss"></i></a></div><div class="header-links-home"><a href="/">Home</a></div><div class="header-links-articles"><a href="/blog">Blog</a></div></nav></header><article class="content blog-article" lang="en"><p>Current DOM specification provides 2 event types for handling keyboard actions<sup><a href="#keypress">[1]</a></sup>:</p><ul><li><code>keydown</code></li><li><code>keyup</code></li></ul><p>These events match the physical actions of pressing and releasing a key of the keyboard, and have a payload with the result of <em>keymapping</em><sup><a href="#keymapping">[2]</a></sup> by the OS (or any software in between), taking into account current <em>layout</em>, modifier and dead keys.</p><p>The result of <em>keymapping</em> is stored in the <code>key</code> property of the event according to the <em>key algorithm</em><sup><a href="#keyproperty">[3]</a></sup>. The pressing of a specific key can be caught just by listening for <code>keydown</code> and checking the <code>key</code> prop. e.g.</p><pre><code><span class="hljs-keyword">let</span> shortcutHandler = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-comment">// Shortcut: l</span>
    <span class="hljs-keyword">if</span> (event.key === <span class="hljs-string">'l'</span>) {
        <span class="hljs-comment">// Simplest case; Facebook use the same shortcut to like items in the feed.</span>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'"l" is pressed'</span>)
    }
}

<span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'keydown'</span>, shortcutHandler)
</code></pre><h2 id="modifiers">Modifiers</h2><p>Keyboard shortcuts may require the combination of a character key and one or more modifiers<sup><a href="#modifier">[4]</a></sup>. Modifiers like <code>Meta</code> or <code>Ctrl</code> usually don’t have the purpose of altering the unicode produced by a key, so it’s easy to define and catch a shortcut combination using the modifiers props stored in the event payload. e.g.</p><pre><code>let shortcutHandler = <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span> {
    <span class="hljs-regexp">//</span> Shortcut: Meta+c
    <span class="hljs-keyword">if</span> (event.key === <span class="hljs-string">'c'</span> &amp;&amp; event.metaKey === <span class="hljs-literal">true</span>) {
        <span class="hljs-regexp">//</span> The famous <span class="hljs-string">"Copy"</span> shortcut <span class="hljs-literal">on</span> macOS
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'"Meta+c" pressed'</span>)
    }
}
</code></pre><p>On the other hand <code>Alt</code> and <code>Shift</code> modifiers may alter the unicode produced by a key, leading to issues in shortcut definition and catching. e.g.</p><pre><code><span class="hljs-keyword">let</span> shortcutHandler = (<span class="hljs-keyword">event</span>) =&gt; {
    <span class="hljs-comment">// Shortcut: Meta+Shift+s</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">event</span>.key === <span class="hljs-string">'s'</span> &amp;&amp; <span class="hljs-keyword">event</span>.metaKey === <span class="hljs-literal">true</span> &amp;&amp; <span class="hljs-keyword">event</span>.shiftKey) {
        <span class="hljs-comment">// The "Save All" shortcut</span>
        console.log(<span class="hljs-string">'"Meta+Shift+s" pressed'</span>)

        <span class="hljs-comment">// WARNING</span>
        <span class="hljs-comment">// This won't work becase the "Shift" modifier change the unicode</span>
        <span class="hljs-comment">// of "S" key from "s" (lowercase) to "S" (uppercase)</span>
    }
}
</code></pre><h2 id="normalization">Normalization</h2><p>Fixing the previous example is trivial: just replace the lowercase “s” with the uppercase “S” in the shortcut definition. The new definition considers the effect produced from the <code>Shift</code> modifier, making the code work just fine. e.g.</p><pre><code><span class="hljs-keyword">let</span> shortcutHandler = (<span class="hljs-keyword">event</span>) =&gt; {
    <span class="hljs-comment">// Shortcut: Meta+Shift+S</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">event</span>.key === <span class="hljs-string">'S'</span> &amp;&amp; <span class="hljs-keyword">event</span>.metaKey === <span class="hljs-literal">true</span> &amp;&amp; <span class="hljs-keyword">event</span>.shiftKey) {
        <span class="hljs-comment">// The Normalized "Save All" shortcut</span>
        console.log(<span class="hljs-string">'"Meta+Shift+S" pressed'</span>)

        <span class="hljs-comment">// This works as expected</span>
    }
}
</code></pre><p>Let’s call <strong>Normalization</strong> the action of replacing of the character key in a keyboard shortcut, with the unicode produced from the same character key plus the modifiers in the shortcut.</p><h2 id="layouts">Layouts</h2><p>Normalization falls short when considering multiple layouts; in fact it’s layout dependant. e.g.:</p><ul><li>Normalization<sub>US</sub> for <code>Meta + Shift + 2</code> is <code>Meta + Shift + @</code></li><li>Normalization<sub>IT</sub> for <code>Meta + Shift + 2</code> is <code>Meta + Shift + &quot;</code></li><li>Normalization<sub>FR</sub> for <code>Meta + Shift + 2</code> is <code>Meta + Shift + 2</code>.</li></ul><p>This limits the Normalization effectiveness to just the shortcuts that use a character key for which its modified unicode char, according to the shortcut modifiers, is the same across every layout. Let’s call these shortcuts <em>layout-safe</em>. e.g.:</p><ul><li>Any lowercase [a-z] letter plus the <code>Shift</code> modifier should produce the uppercase version of that letter in every layout.</li></ul><h2 id="recap">Recap</h2><p>When definining shortcuts for the browsers and multiple layouts it’s worth considering that:</p><ul><li>Browsers and OS catch shortcuts too; be aware of collisions.</li><li>Browsers don’t provide an API for knowing the current layout.</li><li>Some key may not be available on some layouts or may require additional modifiers to produce the same character.</li><li>If the shortcut contains a character key, modifiers may change the unicode emitted by the <code>keydown</code> in an unpredictable way.</li></ul><h2 id="workaround-ideas">Workaround Ideas</h2><h3 id="catch-em-all">Catch ‘Em All</h3><p>Given a shortcut, the idea is to collect its Normalization for every layout and listening for all of them.</p><pre><code><span class="hljs-keyword">let</span> shortcutHandler = (<span class="hljs-keyword">event</span>) =&gt; {
    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">event</span>.key === <span class="hljs-string">'2'</span> &amp;&amp; <span class="hljs-keyword">event</span>.metaKey === <span class="hljs-literal">true</span> &amp;&amp; <span class="hljs-keyword">event</span>.shiftKey) ||
        (<span class="hljs-keyword">event</span>.key === <span class="hljs-string">'"'</span> &amp;&amp; <span class="hljs-keyword">event</span>.metaKey === <span class="hljs-literal">true</span> &amp;&amp; <span class="hljs-keyword">event</span>.shiftKey) ||
        (<span class="hljs-keyword">event</span>.key === <span class="hljs-string">'@'</span> &amp;&amp; <span class="hljs-keyword">event</span>.metaKey === <span class="hljs-literal">true</span> &amp;&amp; <span class="hljs-keyword">event</span>.shiftKey)) {
        <span class="hljs-comment">// This catches the "Meta+Shift+2" on US, IT, and FR layouts</span>
        console.log(<span class="hljs-string">'"Meta+Shift+2" pressed'</span>)
    }
}
</code></pre><p>The obvious problem is that every shortcut ends up producing a set of Normalized shortcuts, and if the interesection of these sets is not empty it’s impossible to choose which shortcut was triggered. e.g.</p><ol><li>Normalization<sub>[US, IT]</sub> for <code>Meta+Shift+=</code> is [<code>Meta+Shift++</code>, <code>Meta+Shift+*</code>]</li><li>Normalization<sub>[US, IT]</sub> for <code>Meta+Shift+8</code> is [<code>Meta+Shift+*</code>, <code>Meta+Shift+(</code>]</li></ol><p>Clearly <code>Meta+Shift+*</code> falls into the intersection, making impossible to know if the source is <code>Meta+Shift+=</code> on IT layout or <code>Meta+Shift+8</code> on US layout.</p><h3 id="just-ask">Just Ask</h3><p>The application can infere the keyboard layout using language and location of the browser. Then the Normalization function for such layout is used for catching shortcuts unambiguosly.</p><h3 id="recovering-numbers">Recovering Numbers</h3><p>Shortcuts with number keys plus modifiers are not <em>layout-safe</em>. However, the number keys position on the physical layout should be the same for most of Latin script layouts <a href="#latinscript">[6]</a>. Using the <code>code</code> property of <code>keydown</code> event <a href="#keycode">[5]</a>, should be possible to check for numeric keys without ambiguity, as the <code>code</code> property returns the keycode before keymapping is applied.</p><pre><code>let shortcutHandler = <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (event.code === <span class="hljs-string">'Digit2'</span> &amp;&amp; event.metaKey === <span class="hljs-literal">true</span> &amp;&amp; event.shiftKey) {
        <span class="hljs-regexp">//</span> This also catches <span class="hljs-string">"Meta+Shift+2"</span> <span class="hljs-literal">on</span> Latin Script based layouts
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'"Meta+Shift+2" pressed'</span>)
    }
}
</code></pre><h3 id="further-readings">Further readings</h3><ul><li>Internationalize your keyboard controls by Julien Wajsberg, Mozilla Hacks, <a href="https://hacks.mozilla.org/2017/03/internationalize-your-keyboard-controls/" target="_blank">https://hacks.mozilla.org/2017/03/internationalize-your-keyboard-controls/</a></li><li>Can I Use KeyboardEvent.key, Can I Use, <a target="_blank" href="https://caniuse.com/#feat=keyboardevent-key">https://caniuse.com/#feat=keyboardevent-key</a></li><li>Can I Use KeyboardEvent.code, Can I Use, <a target="_blank" href="https://caniuse.com/#feat=keyboardevent-code">https://caniuse.com/#feat=keyboardevent-code</a></li></ul><h3 id="references">References</h3><ol><li>Keypress Event Types - DOM 3 Level Specifications, W3C, <a href="https://www.w3.org/TR/DOM-Level-3-Events/#events-keyboard-types" target="_blank" id="keypress">https://www.w3.org/TR/DOM-Level-3-Events/#events-keyboardevents</a></li><li>Key Mapping, W3C, <a href="https://www.w3.org/TR/DOM-Level-3-Events/#key-mapping" target="_blank" id="keymapping">https://www.w3.org/TR/DOM-Level-3-Events/#key-mapping</a></li><li><code>key</code> Property of KeyboardEvent, W3C, <a href="https://www.w3.org/TR/DOM-Level-3-Events/#key-algorithm" target="_blank" id="keyproperty">https://www.w3.org/TR/DOM-Level-3-Events/#key-algorithm</a></li><li>Modifier Key, Wikipedia, <a href="https://en.wikipedia.org/wiki/Modifier_key" target="_blank" id="modifier">https://en.wikipedia.org/wiki/Modifier_key</a></li><li>Key Codes, W3C, <a href="https://www.w3.org/TR/DOM-Level-3-Events/#keys-codevalues" target="_blank" id="keycode">https://www.w3.org/TR/DOM-Level-3-Events/#keys-codevalues</a></li><li>QWERTY-based layouts for Latin script, Keyboard Layout, Wikipedia, <a href="https://en.wikipedia.org/wiki/Keyboard_layout#QWERTY-based_layouts_for_Latin_script" target="_blank" id="latinscript">https://en.wikipedia.org/wiki/Keyboard_layout#QWERTY-based_layouts_for_Latin_script</a></li></ol><p><em>– 22/05/2017</em></p></article><footer class="footer"><div>© Stefano Brilli. All Rights Reserved.</div><div><a id="toggle-grid" href="#">toggle grid</a></div></footer></div><!-- Google Analytics: change UA-XXXXX-X to be your site's ID. --><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='https://www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create','UA-60498490-1');ga('send','pageview');</script><script src="/scripts/vendor-4637e41d8f.js"></script><script src="/scripts/main-398d21b2c9.js"></script><script>hljs.initHighlightingOnLoad();</script></body></html>