<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Inspiration Code - part 3</title><meta name="description" content="Code I wrote after reading a book - third part"/><meta property="og:title" content="Inspiration Code - part 3"/><meta name="og:description" content="Code I wrote after reading a book - third part"/><meta property="og:url" content="https://stefano.brilli.me/blog/inspiration_code3/"/><meta property="og:type" content="website"/><meta name="next-head-count" content="8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="preconnect" href="https://cdnjs.cloudflare.com"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.3/katex.min.css" integrity="sha512-07YhC3P4/vS5HdgGuNAAeIxb5ee//efgRNo5AGdMtqFBUPYOdQG/sDK0Nl5qNq94kdEk/Pvu8pmN4GYUeucUkw==" crossorigin="anonymous" referrerPolicy="no-referrer"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/23b632ecbbf88eb8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/23b632ecbbf88eb8.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-5752944655d749a0.js" defer=""></script><script src="/_next/static/chunks/framework-a87821de553db91d.js" defer=""></script><script src="/_next/static/chunks/main-250a0b3dc1fc1f02.js" defer=""></script><script src="/_next/static/chunks/pages/_app-08f9979ebc4e297a.js" defer=""></script><script src="/_next/static/chunks/1bfc9850-b964ecc8fc6be6a1.js" defer=""></script><script src="/_next/static/chunks/440-9ab67ee21eaa4db8.js" defer=""></script><script src="/_next/static/chunks/294-5a7641993238b3cf.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-8674bd6fffbba048.js" defer=""></script><script src="/_next/static/gl6wU_kcT8lmZpUDfSzMW/_buildManifest.js" defer=""></script><script src="/_next/static/gl6wU_kcT8lmZpUDfSzMW/_ssgManifest.js" defer=""></script><script src="/_next/static/gl6wU_kcT8lmZpUDfSzMW/_middlewareManifest.js" defer=""></script><style data-emotion="css "></style><style data-href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap">@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc6CsI.woff) format('woff')}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc3CsTYl4BOQ3o.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc-CsTYl4BOQ3o.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc2CsTYl4BOQ3o.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc5CsTYl4BOQ3o.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc0CsTYl4BOQ3o.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntumono/v15/KFOjCneDtsqEr0keqCMhbCc6CsTYl4BO.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style><style data-href="https://fonts.googleapis.com/css?family=Roboto:400,100italic,100,300,900&display=swap">@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEzAdKQ.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxIIzQ.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBBc-.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxM.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfBBc-.woff) format('woff')}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEz0dL-vwnYh2eg.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEzQdL-vwnYh2eg.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEzwdL-vwnYh2eg.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEzMdL-vwnYh2eg.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEz8dL-vwnYh2eg.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEz4dL-vwnYh2eg.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:italic;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOiCnqEu92Fr1Mu51QrEzAdL-vwnYg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxFIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxMIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxEIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxLIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxHIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxGIzIXKMnyrYk.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOkCnqEu92Fr1MmgVxIIzIXKMny.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fCRc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fABc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fCBc4AMP6lbBP.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fCxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fChc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBBc4AMP6lQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu72xKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu5mxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu7mxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu4WxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu7WxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu7GxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxKKTU1Kg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfCRc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfABc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfCBc4AMP6lbBP.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfBxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfCxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfChc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v29/KFOlCnqEu92Fr1MmYUtfBBc4AMP6lQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style><style data-href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,700&display=swap">@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZOf-Q.woff) format('woff')}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-fCZK.woff) format('woff')}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZWMf8.woff) format('woff')}@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZDf-LVrPHpBXw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZKf-LVrPHpBXw.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZBf-LVrPHpBXw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZAf-LVrPHpBXw.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Merriweather';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4m0qyriQwlOrhSvowK_l5-eRZOf-LVrPHp.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-cSZMdeX3rsHo.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-eCZMdeX3rsHo.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-cyZMdeX3rsHo.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-ciZMdeX3rsHo.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Merriweather';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-440qyriQwlOrhSvowK_l5-fCZMdeX3rg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZVcf6hPvhPUWH.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZXMf6hPvhPUWH.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZV8f6hPvhPUWH.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZVsf6hPvhPUWH.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Merriweather';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/merriweather/v30/u-4n0qyriQwlOrhSvowK_l52xwNZWMf6hPvhPQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><main class="container"><header class="site-header"><nav class="site-header-nav"><a href="/feed.rss" rel="alternate" type="application/rss+xml"><i class="fa fa-rss"></i></a><span></span><a href="/">Home</a><a href="/blog/">Blog</a></nav></header><article class="content blog-article" lang="en"><h1>Inspiration Code</h1>
<h2>Part 3</h2>
<p>The last of these three parts summary is about <code>_thread</code> and <code>Result</code> structures.</p>
<p><code>_thread</code> is a just a container for <code>pthread_t</code> and <code>pthread_attr_t</code> thread variables. It provides a wrapper for pthread_create and pthread_detach functions, and a member variable for storing the called function return value… However the most important task accomplished by this structure is reference counting.</p>
<pre><code class="hljs language-arduino"><span class="hljs-keyword">template</span> &#x3C;<span class="hljs-keyword">typename</span> T> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_thread</span>
{
    <span class="hljs-comment">// This struct will hold the return value of the thread called func.</span>

    _thread() : <span class="hljs-built_in">counter</span>(<span class="hljs-number">0</span>)
    {
        <span class="hljs-built_in">pthread_attr_init</span>(&#x26;attr);
        <span class="hljs-built_in">pthread_attr_setdetachstate</span>(&#x26;attr, PTHREAD_CREATE_JOINABLE);
    }

    ~_thread() { <span class="hljs-built_in">pthread_detach</span>(thd); }

    T result;
    <span class="hljs-type">pthread_t</span> thd;
    <span class="hljs-type">pthread_attr_t</span> attr;
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> counter;

    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">join</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">pthread_join</span>(thd, <span class="hljs-literal">NULL</span>); }
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">start</span><span class="hljs-params">(<span class="hljs-type">void</span>*(f)(<span class="hljs-type">void</span>*), <span class="hljs-type">void</span>* v)</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">pthread_create</span>(&#x26;thd, &#x26;attr, f, v);
    }

    <span class="hljs-comment">// Atomic function for add and sub</span>
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">inc</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> __sync_fetch_and_add(&#x26;counter, <span class="hljs-number">1</span>); }
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">dec</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">if</span> (__sync_fetch_and_sub(&#x26;counter, <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>)
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> counter;
    }

    <span class="hljs-keyword">private</span>:
    _thread(<span class="hljs-type">const</span> _thread&#x26;);
    _thread&#x26; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> _thread&#x26;);
};
</code></pre>
<p><code>_thread</code> has both inc/dec member functions that are called everytime the structure instance is referenced/dereferenced by some other object. When the dec member function is called and the counter becomes zero, then the destructor is invoked and <code>_thread</code> is deleted. Also, the destructor calls <code>pthread_detach</code>, so that thread’s resources can be freed.</p>
<p>This reference counting mechanism is very important since we want that <code>_help_fn</code> and <code>_help_st</code> saves the computation results in a place from which we can fetch the result…</p>
<p>To clarify: we can’t just launch the thread (that executes <code>_help_fn</code>), save the results and delete everything. We need to be sure that we are deleting the result at the right time.</p>
<p>This is why, when a new thread is created, the corresponding <code>_thread</code> object is referenced both by a <code>_help_st</code> and a <code>Result</code> object. In this way, at the end of <code>_help_fn</code>, when <code>_help_st</code> is deleted, the dec function of <code>_thread</code> object is called by <code>_help_st</code> destructor…
But <code>_thread</code> object is deleted only if also the corresponding <code>Result</code> object is already deleted.</p>
<pre><code class="hljs language-scss">template &#x3C;typename T> struct Result
{

    <span class="hljs-built_in">Result</span>(_thread&#x3C;T>* thd) : thd(thd)
    {
        thd-><span class="hljs-built_in">inc</span>();
    }

    <span class="hljs-built_in">Result</span>(const Result&#x3C;T>&#x26; o)
    {
        thd-><span class="hljs-built_in">inc</span>();
        thd = o<span class="hljs-selector-class">.thd</span>;
    }

    Result&#x3C;T>&#x26; operator=(const Result&#x26; o)
    {
        o<span class="hljs-selector-class">.thd-</span>><span class="hljs-built_in">inc</span>();
        thd-><span class="hljs-built_in">dec</span>();
        thd = o<span class="hljs-selector-class">.thd</span>;
        return *this;
    }

    T <span class="hljs-built_in">value</span>()
    {
        switch (thd->join())
        {
            case <span class="hljs-number">0</span>:
              break;
            case EINVAL:
              throw std::runtime_error(<span class="hljs-string">"EINVAL on pthread_join"</span>);
              break;
            case EDEADLK:
              throw std::runtime_error(<span class="hljs-string">"EDEADLK on pthread_join"</span>);
              break;
            case ESRCH:
              // Thread already exited
              break;
        }
        return thd->result;
    }

    ~<span class="hljs-built_in">Result</span>()
    {
        thd-><span class="hljs-built_in">dec</span>();
    }

    _thread&#x3C;T>* thd;
}
</code></pre>
<p>The <code>Result</code> object is the one that is returned to the user who started a new thread. So, if the user keep it, he can fetch the return value through the <code>Result</code> object.
Otherwise the <code>Result</code> object is automatically destroyed and corresponding <code>_thread</code> object is deleted when dec is called by <code>_help_st</code> destructor.</p>
<p>To close this last part, here are the static methods of <code>Thread</code> class for creating a new thread that runs a function, a functor or an instance method having one argument. The signature is similar for functions, functors, and instance methods having more than one arument.
As you see the return value of these function is a <code>Result</code> object.</p>
<pre><code class="hljs language-kotlin">template &#x3C;typename T, typename O, typename I0> static Result&#x3C;T>
run(O obj, I0 a0)
{
    _functor1&#x3C;T, O, I0> o(obj, a0);
    <span class="hljs-keyword">return</span> Result&#x3C;T>(_start&#x3C;T>(o));
}

template &#x3C;typename T, typename I0> static Result&#x3C;T>
run(T(*<span class="hljs-function"><span class="hljs-keyword">fun</span>)<span class="hljs-params">(I0)</span></span>, I0 a0)
{
    _functor1&#x3C;T, T(*)(I0), I0> f(<span class="hljs-function"><span class="hljs-keyword">fun</span>, a0);</span>
    <span class="hljs-keyword">return</span> Result&#x3C;T>(_start&#x3C;T>(f));
}

template &#x3C;typename T, typename C, typename I0> static Result&#x3C;T>
run(C* c, T(C::*<span class="hljs-function"><span class="hljs-keyword">fun</span>)<span class="hljs-params">(I0)</span></span>, I0 a0)
{
    _class_functor1&#x3C;T, C, I0> f(c, <span class="hljs-function"><span class="hljs-keyword">fun</span>, a0);</span>
    <span class="hljs-keyword">return</span> Result&#x3C;T>(_start&#x3C;T>(f));
}
</code></pre>
<p>Returning <code>Result</code> object is assigned a <code>_thread</code> object, created by <code>_start</code> helper function in <code>Thread</code> class.</p>
<pre><code class="hljs language-r">template <span class="hljs-operator">&#x3C;</span>typename <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span> typename <span class="hljs-built_in">F</span><span class="hljs-operator">></span> static _thread<span class="hljs-operator">&#x3C;</span><span class="hljs-built_in">T</span><span class="hljs-operator">></span><span class="hljs-operator">*</span>
_start<span class="hljs-punctuation">(</span>const <span class="hljs-built_in">F</span><span class="hljs-operator">&#x26;</span> functor<span class="hljs-punctuation">)</span>
<span class="hljs-punctuation">{</span>
    _thread<span class="hljs-operator">&#x3C;</span><span class="hljs-built_in">T</span><span class="hljs-operator">></span><span class="hljs-operator">*</span> mythread <span class="hljs-operator">=</span> new _thread<span class="hljs-operator">&#x3C;</span><span class="hljs-built_in">T</span><span class="hljs-operator">></span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span>;
    _help_st<span class="hljs-operator">&#x3C;</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">F</span> <span class="hljs-operator">></span><span class="hljs-operator">*</span> h2 <span class="hljs-operator">=</span> new _help_st<span class="hljs-operator">&#x3C;</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">F</span><span class="hljs-operator">></span><span class="hljs-punctuation">(</span>mythread<span class="hljs-punctuation">,</span> functor<span class="hljs-punctuation">)</span>;
    mythread<span class="hljs-operator">-></span>start<span class="hljs-punctuation">(</span>_help_fn<span class="hljs-operator">&#x3C;</span>_help_st<span class="hljs-operator">&#x3C;</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">F</span><span class="hljs-operator">></span> <span class="hljs-operator">></span><span class="hljs-punctuation">,</span> h2<span class="hljs-punctuation">)</span>;
    <span class="hljs-built_in">return</span> mythread;
<span class="hljs-punctuation">}</span>
</code></pre>
<p>I hope you enjoyed this post serie… If you have question or you need some clarification, just leave a comment. I will be happy to answer or rewrite the unclear part</p>
<p><em>— 29/12/2011</em></p></article><footer class="footer"><div class="footer-contacts"><a href="https://twitter.com/thecybercase" target="_blank" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://github.com/cybercase" target="_blank" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a href="https://it.linkedin.com/pub/stefano-brilli/21/650/953" target="_blank" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a href="mailto:stefano@brilli.me"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a></div><div>© Stefano Brilli. All Rights Reserved.</div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"inspiration_code3","title":"Inspiration Code - part 3","description":"Code I wrote after reading a book - third part","date":"2011-12-29T00:00:01.000Z","content":"\u003ch1\u003eInspiration Code\u003c/h1\u003e\n\u003ch2\u003ePart 3\u003c/h2\u003e\n\u003cp\u003eThe last of these three parts summary is about \u003ccode\u003e_thread\u003c/code\u003e and \u003ccode\u003eResult\u003c/code\u003e structures.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e_thread\u003c/code\u003e is a just a container for \u003ccode\u003epthread_t\u003c/code\u003e and \u003ccode\u003epthread_attr_t\u003c/code\u003e thread variables. It provides a wrapper for pthread_create and pthread_detach functions, and a member variable for storing the called function return value… However the most important task accomplished by this structure is reference counting.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-arduino\"\u003e\u003cspan class=\"hljs-keyword\"\u003etemplate\u003c/span\u003e \u0026#x3C;\u003cspan class=\"hljs-keyword\"\u003etypename\u003c/span\u003e T\u003e \u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003e_thread\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-comment\"\u003e// This struct will hold the return value of the thread called func.\u003c/span\u003e\n\n    _thread() : \u003cspan class=\"hljs-built_in\"\u003ecounter\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\n    {\n        \u003cspan class=\"hljs-built_in\"\u003epthread_attr_init\u003c/span\u003e(\u0026#x26;attr);\n        \u003cspan class=\"hljs-built_in\"\u003epthread_attr_setdetachstate\u003c/span\u003e(\u0026#x26;attr, PTHREAD_CREATE_JOINABLE);\n    }\n\n    ~_thread() { \u003cspan class=\"hljs-built_in\"\u003epthread_detach\u003c/span\u003e(thd); }\n\n    T result;\n    \u003cspan class=\"hljs-type\"\u003epthread_t\u003c/span\u003e thd;\n    \u003cspan class=\"hljs-type\"\u003epthread_attr_t\u003c/span\u003e attr;\n    \u003cspan class=\"hljs-keyword\"\u003evolatile\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e counter;\n\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ejoin\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e \u003c/span\u003e{ \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003epthread_join\u003c/span\u003e(thd, \u003cspan class=\"hljs-literal\"\u003eNULL\u003c/span\u003e); }\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003estart\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-type\"\u003evoid\u003c/span\u003e*(f)(\u003cspan class=\"hljs-type\"\u003evoid\u003c/span\u003e*), \u003cspan class=\"hljs-type\"\u003evoid\u003c/span\u003e* v)\u003c/span\u003e\n    \u003c/span\u003e{\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003epthread_create\u003c/span\u003e(\u0026#x26;thd, \u0026#x26;attr, f, v);\n    }\n\n    \u003cspan class=\"hljs-comment\"\u003e// Atomic function for add and sub\u003c/span\u003e\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003einc\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e \u003c/span\u003e{ \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e __sync_fetch_and_add(\u0026#x26;counter, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e); }\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003edec\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\n    \u003c/span\u003e{\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__sync_fetch_and_sub(\u0026#x26;counter, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e) == \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\n            \u003cspan class=\"hljs-keyword\"\u003edelete\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ethis\u003c/span\u003e;\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e counter;\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e:\n    _thread(\u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e _thread\u0026#x26;);\n    _thread\u0026#x26; \u003cspan class=\"hljs-keyword\"\u003eoperator\u003c/span\u003e=(\u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e _thread\u0026#x26;);\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003e_thread\u003c/code\u003e has both inc/dec member functions that are called everytime the structure instance is referenced/dereferenced by some other object. When the dec member function is called and the counter becomes zero, then the destructor is invoked and \u003ccode\u003e_thread\u003c/code\u003e is deleted. Also, the destructor calls \u003ccode\u003epthread_detach\u003c/code\u003e, so that thread’s resources can be freed.\u003c/p\u003e\n\u003cp\u003eThis reference counting mechanism is very important since we want that \u003ccode\u003e_help_fn\u003c/code\u003e and \u003ccode\u003e_help_st\u003c/code\u003e saves the computation results in a place from which we can fetch the result…\u003c/p\u003e\n\u003cp\u003eTo clarify: we can’t just launch the thread (that executes \u003ccode\u003e_help_fn\u003c/code\u003e), save the results and delete everything. We need to be sure that we are deleting the result at the right time.\u003c/p\u003e\n\u003cp\u003eThis is why, when a new thread is created, the corresponding \u003ccode\u003e_thread\u003c/code\u003e object is referenced both by a \u003ccode\u003e_help_st\u003c/code\u003e and a \u003ccode\u003eResult\u003c/code\u003e object. In this way, at the end of \u003ccode\u003e_help_fn\u003c/code\u003e, when \u003ccode\u003e_help_st\u003c/code\u003e is deleted, the dec function of \u003ccode\u003e_thread\u003c/code\u003e object is called by \u003ccode\u003e_help_st\u003c/code\u003e destructor…\nBut \u003ccode\u003e_thread\u003c/code\u003e object is deleted only if also the corresponding \u003ccode\u003eResult\u003c/code\u003e object is already deleted.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-scss\"\u003etemplate \u0026#x3C;typename T\u003e struct Result\n{\n\n    \u003cspan class=\"hljs-built_in\"\u003eResult\u003c/span\u003e(_thread\u0026#x3C;T\u003e* thd) : thd(thd)\n    {\n        thd-\u003e\u003cspan class=\"hljs-built_in\"\u003einc\u003c/span\u003e();\n    }\n\n    \u003cspan class=\"hljs-built_in\"\u003eResult\u003c/span\u003e(const Result\u0026#x3C;T\u003e\u0026#x26; o)\n    {\n        thd-\u003e\u003cspan class=\"hljs-built_in\"\u003einc\u003c/span\u003e();\n        thd = o\u003cspan class=\"hljs-selector-class\"\u003e.thd\u003c/span\u003e;\n    }\n\n    Result\u0026#x3C;T\u003e\u0026#x26; operator=(const Result\u0026#x26; o)\n    {\n        o\u003cspan class=\"hljs-selector-class\"\u003e.thd-\u003c/span\u003e\u003e\u003cspan class=\"hljs-built_in\"\u003einc\u003c/span\u003e();\n        thd-\u003e\u003cspan class=\"hljs-built_in\"\u003edec\u003c/span\u003e();\n        thd = o\u003cspan class=\"hljs-selector-class\"\u003e.thd\u003c/span\u003e;\n        return *this;\n    }\n\n    T \u003cspan class=\"hljs-built_in\"\u003evalue\u003c/span\u003e()\n    {\n        switch (thd-\u003ejoin())\n        {\n            case \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e:\n              break;\n            case EINVAL:\n              throw std::runtime_error(\u003cspan class=\"hljs-string\"\u003e\"EINVAL on pthread_join\"\u003c/span\u003e);\n              break;\n            case EDEADLK:\n              throw std::runtime_error(\u003cspan class=\"hljs-string\"\u003e\"EDEADLK on pthread_join\"\u003c/span\u003e);\n              break;\n            case ESRCH:\n              // Thread already exited\n              break;\n        }\n        return thd-\u003eresult;\n    }\n\n    ~\u003cspan class=\"hljs-built_in\"\u003eResult\u003c/span\u003e()\n    {\n        thd-\u003e\u003cspan class=\"hljs-built_in\"\u003edec\u003c/span\u003e();\n    }\n\n    _thread\u0026#x3C;T\u003e* thd;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe \u003ccode\u003eResult\u003c/code\u003e object is the one that is returned to the user who started a new thread. So, if the user keep it, he can fetch the return value through the \u003ccode\u003eResult\u003c/code\u003e object.\nOtherwise the \u003ccode\u003eResult\u003c/code\u003e object is automatically destroyed and corresponding \u003ccode\u003e_thread\u003c/code\u003e object is deleted when dec is called by \u003ccode\u003e_help_st\u003c/code\u003e destructor.\u003c/p\u003e\n\u003cp\u003eTo close this last part, here are the static methods of \u003ccode\u003eThread\u003c/code\u003e class for creating a new thread that runs a function, a functor or an instance method having one argument. The signature is similar for functions, functors, and instance methods having more than one arument.\nAs you see the return value of these function is a \u003ccode\u003eResult\u003c/code\u003e object.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-kotlin\"\u003etemplate \u0026#x3C;typename T, typename O, typename I0\u003e static Result\u0026#x3C;T\u003e\nrun(O obj, I0 a0)\n{\n    _functor1\u0026#x3C;T, O, I0\u003e o(obj, a0);\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e Result\u0026#x3C;T\u003e(_start\u0026#x3C;T\u003e(o));\n}\n\ntemplate \u0026#x3C;typename T, typename I0\u003e static Result\u0026#x3C;T\u003e\nrun(T(*\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e)\u003cspan class=\"hljs-params\"\u003e(I0)\u003c/span\u003e\u003c/span\u003e, I0 a0)\n{\n    _functor1\u0026#x3C;T, T(*)(I0), I0\u003e f(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e, a0);\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e Result\u0026#x3C;T\u003e(_start\u0026#x3C;T\u003e(f));\n}\n\ntemplate \u0026#x3C;typename T, typename C, typename I0\u003e static Result\u0026#x3C;T\u003e\nrun(C* c, T(C::*\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e)\u003cspan class=\"hljs-params\"\u003e(I0)\u003c/span\u003e\u003c/span\u003e, I0 a0)\n{\n    _class_functor1\u0026#x3C;T, C, I0\u003e f(c, \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e, a0);\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e Result\u0026#x3C;T\u003e(_start\u0026#x3C;T\u003e(f));\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eReturning \u003ccode\u003eResult\u003c/code\u003e object is assigned a \u003ccode\u003e_thread\u003c/code\u003e object, created by \u003ccode\u003e_start\u003c/code\u003e helper function in \u003ccode\u003eThread\u003c/code\u003e class.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-r\"\u003etemplate \u003cspan class=\"hljs-operator\"\u003e\u0026#x3C;\u003c/span\u003etypename \u003cspan class=\"hljs-built_in\"\u003eT\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e typename \u003cspan class=\"hljs-built_in\"\u003eF\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e\u003e\u003c/span\u003e static _thread\u003cspan class=\"hljs-operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"hljs-built_in\"\u003eT\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e\n_start\u003cspan class=\"hljs-punctuation\"\u003e(\u003c/span\u003econst \u003cspan class=\"hljs-built_in\"\u003eF\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e\u0026#x26;\u003c/span\u003e functor\u003cspan class=\"hljs-punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n    _thread\u003cspan class=\"hljs-operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"hljs-built_in\"\u003eT\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e mythread \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e new _thread\u003cspan class=\"hljs-operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"hljs-built_in\"\u003eT\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e)\u003c/span\u003e;\n    _help_st\u003cspan class=\"hljs-operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"hljs-built_in\"\u003eT\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eF\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e h2 \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e new _help_st\u003cspan class=\"hljs-operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"hljs-built_in\"\u003eT\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eF\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e(\u003c/span\u003emythread\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e functor\u003cspan class=\"hljs-punctuation\"\u003e)\u003c/span\u003e;\n    mythread\u003cspan class=\"hljs-operator\"\u003e-\u003e\u003c/span\u003estart\u003cspan class=\"hljs-punctuation\"\u003e(\u003c/span\u003e_help_fn\u003cspan class=\"hljs-operator\"\u003e\u0026#x3C;\u003c/span\u003e_help_st\u003cspan class=\"hljs-operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"hljs-built_in\"\u003eT\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eF\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e h2\u003cspan class=\"hljs-punctuation\"\u003e)\u003c/span\u003e;\n    \u003cspan class=\"hljs-built_in\"\u003ereturn\u003c/span\u003e mythread;\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI hope you enjoyed this post serie… If you have question or you need some clarification, just leave a comment. I will be happy to answer or rewrite the unclear part\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e— 29/12/2011\u003c/em\u003e\u003c/p\u003e"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"inspiration_code3"},"buildId":"gl6wU_kcT8lmZpUDfSzMW","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>