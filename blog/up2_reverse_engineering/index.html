<!doctype html><html lang=""><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Jawbone UP2 vibration hack"><meta property="og:title" content="UP2 Reverse Engineering"><meta property="og:site_name" content="Stefano Brilli Home Page"><meta property="og:type" content="article"><meta property="og:locale" content="en_US"><meta property="og:image" content="/images/up2_band.png"><meta property="article:author" content="Stefano Brilli"><title>UP2 Reverse Engineering</title><link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto:400,100italic,100,300,900" rel="stylesheet" type="text/css"><link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="/styles/vendor-a3db57aa98.css"><link rel="stylesheet" href="/styles/main-5e2edbf30c.css"></head><body><div class="container"><header class="header header--cover header--dark"><div class="header-image" style="background-image: url(/images/up2_band.png)"><div class="header-image-box"><h1 class="header-image-title">UP2 Reverse Engineering</h1></div></div><div class="header-text">Charging my new UP2</div><nav class="header-links"><div class="header-links-rss"><a href="/feed.rss" rel="alternate" type="application/rss+xml"><i class="fa fa-rss"></i></a></div><div class="header-links-home"><a href="/">Home</a></div><div class="header-links-articles"><a href="/blog">Blog</a></div></nav></header><article class="content blog-article" lang="en"><p><strong>July 2018 UPDATE:</strong> I’ve released the source code of this project on github.<br>Find out more here: <a href="https://github.com/cybercase/up2_hacking">https://github.com/cybercase/up2_hacking</a></p><h3 id="having-fun-with-jawbone-up2">Having fun with Jawbone UP2</h3><p>A few months after releasing <a href="../up24_notifications">UpNotifications for UP24</a> I received a lot of emails asking to add support for the new <strong>Jawbone UP2</strong>.</p><p>As soon as Jawbone made the UP2 available outside the US I placed my order, and after receiving the new band, without thinking too much I started tuning the UpNotifications source code to include the UP2 among supported devices just to see if the same hack used for UP24 was working also on this band…</p><blockquote><p>Unfortunately, it was not.</p></blockquote><p>I didn’t give up, and following the same steps of my own <a href="../up24_reverse_engineering">UP24 Hacking</a> blogpost, I opened Android Studio, turned on the debugger, started intercepting calls to the android BLE API and see what has changed with respect to UP24…</p><p>The bluetooth packets I was reading were completely different from the UP24 packets, so I thought that maybe it was just a matter of replacing the old UP24’s pairing command with the new UP2’s one. And so I did.</p><p>I soon found out that the same trick of <em>sending a pairing command to make the band vibrate</em> was not working because the new UP2 knows if it has been already paired with a phone, and in that case it does not vibrate on pairing.</p><p>While the UP24 <strong>allowed anyone</strong> to make vibrate your band without your permission just by sending a pairing command, with the UP2 <strong>Jawbone has fixed this issue</strong>. Though this is a good news for all UP2 owners, this meant that I had to find another way to trigger the vibration.</p><blockquote><p>I needed to go deeper.</p></blockquote><p>I struggled to understand how the communication protocol has changed, and see if I could find another command to exploit. But just looking at the stream of bluetooth packets wasn’t enough…</p><p>so I though of disassembling the app and inspecting its <code>.smali</code> source code using <a href="http://ibotpeaches.github.io/Apktool/">apktool</a> to search for anything that could be useful.</p><p>After going through the sources for a while I noticed a <code>log</code> method used all over the app, probably for debugging purposes, that was disabled just by a simple flag check.</p><p>In a file called <code>JBLog.smali</code>, I changed the following lines</p><pre><code>-   <span class="hljs-built_in"> if-nez </span>v0,<span class="hljs-keyword"> :cond_0</span>
+   <span class="hljs-built_in"> if-eqz </span>v0,<span class="hljs-keyword"> :cond_0</span>
</code></pre><p>then reassembled the app and installed into my phone.</p><blockquote><p>I started getting a lot of debug information placed there right from UP developers :)</p></blockquote><p>I immediately found out that the communication protocol was much more sophisticated than the one used for UP24.</p><p>Log messages like this</p><pre><code><span class="hljs-number">8257</span><span class="hljs-number">-8288</span>/com.jawbone.upopen I/UPOPEN﹕ StreamService &gt;&gt;&gt; writeOutputStream &gt; KeyExchangeRequest &gt;
    f &gt;&gt; (<span class="hljs-number">0</span>, <span class="hljs-number">63</span>, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0x03</span>
    g &gt;&gt; (<span class="hljs-number">1</span>, <span class="hljs-number">63</span>, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0x00</span>
    h &gt;&gt; (<span class="hljs-number">2</span>, <span class="hljs-number">63</span>, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0xd3</span>
    i &gt;&gt; (<span class="hljs-number">3</span>, <span class="hljs-number">63</span>, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0x10</span>
    d &gt;&gt; (<span class="hljs-number">4</span>, <span class="hljs-number">63</span>, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">7</span>FA19B1353FC584CAEF3D4214C74A365
</code></pre><p>and</p><pre><code><span class="hljs-number">8257</span><span class="hljs-number">-7505</span>/com.jawbone.upopen D/SecuredStream﹕ generateSeed &gt; <span class="hljs-number">271372323671</span>BDEE846276EF48B53F75
<span class="hljs-number">8257</span><span class="hljs-number">-7505</span>/com.jawbone.upopen D/SecuredStream﹕ <span class="hljs-number">8200</span>CD05803A090000 xor D4CB772B8B9D389527 = <span class="hljs-number">56</span>CBBA2E0BA7319527
</code></pre><p>and</p><pre><code><span class="hljs-number">8257</span><span class="hljs-number">-7505</span>/com.jawbone.upopen I/UPOPEN﹕ StreamService &gt;&gt;&gt; writeOutputStream &gt; SecureChannelRequest &gt;
    f &gt;&gt; (<span class="hljs-number">0</span>, <span class="hljs-number">63</span>, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0x06</span>
    g &gt;&gt; (<span class="hljs-number">1</span>, <span class="hljs-number">63</span>, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0x00</span>
    h &gt;&gt; (<span class="hljs-number">2</span>, <span class="hljs-number">63</span>, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0xd0</span>
    i &gt;&gt; (<span class="hljs-number">3</span>, <span class="hljs-number">63</span>, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0x10</span>
    c &gt;&gt; (<span class="hljs-number">4</span>, <span class="hljs-number">63</span>, <span class="hljs-number">0</span>) &gt; F9FC5162DC8B609B6F891BC88648A49A
    d &gt;&gt; (<span class="hljs-number">4</span>, <span class="hljs-number">63</span>, <span class="hljs-number">0</span>) &gt; null
</code></pre><p>were suggesting that the protocol was relying on some kind of encryption to communicate over a secure channel, using a shared encryption key exchanged at the time of pairing.</p><blockquote><p>I needed more, so I thought of using a decompiler.</p></blockquote><p>I tried some like <a href="https://bitbucket.org/mstrobel/procyon/">Procyon</a>, <a href="http://www.benf.org/other/cfr/">CFR</a> to get as much information as possible. With the help of a great tool called <a href="https://github.com/Konloch/bytecode-viewer">BytecodeViewer</a>, I stared to follow the code paths, drawing diagrams, understand the app flow and structures…</p><p>Eventually I reproduced all the steps needed to pair and setup an encrypted communication channel with the UP2 and send the vibration command I needed :)</p><iframe class="line-11-m line-17-d" src="//www.youtube.com/embed/uwsyjyM5GJU" frameborder="0" allowfullscreen></iframe><blockquote><p>Victory! … almost.</p></blockquote><p>As I came back on my initial goal of integrating UP2 support into UpNotifications, I realized that it would be very hard to achieve any kind of <em>user friendly</em> experience.</p><p>The first problem comes from the fact that the encryption key is kept secret into the original UP application, and the only way to retrieve such key is to have a <em>rooted</em> phone.</p><p>The second crucial problem is that, even if it was possible to get the encryption key easily, UP2 supports only one bluetooth connection at time. This means that an <em>UpNotifications for UP2</em> would not work while the band is connected to the original UP application.</p><p>And since there’s no way (without root permission) to control when the UP app runs or communicates with the band, <strong>UpNotifications for UP2 would be incompatible with the official UP app</strong>.</p><blockquote><p>I still haven’t decided whether write an <em>UpNotifications for UP2</em> or not…</p></blockquote><p><del>So, for the time being, I’m not releasing the source code of the “test” app I wrote</del> (moreover, currently the code is quite a mess).</p><p>Also, I want to be sure of the legal consequences of releasing any protocol specs…</p><p>Unlike the old UP24, Jawbone is using this protocol on devices like UP4 for <a href="https://jawbone.com/blog/introducing-up4/">contactless payments</a>, so this time they could be much more interested in keeping the protocol as much secret as possible to avoid security issues.</p><p><em>– 19/09/2015</em></p></article><footer class="footer"><div>© Stefano Brilli. All Rights Reserved.</div><div><a id="toggle-grid" href="#">toggle grid</a></div></footer></div><!-- Google Analytics: change UA-XXXXX-X to be your site's ID. --><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='https://www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create','UA-60498490-1');ga('send','pageview');</script><script src="/scripts/vendor-4637e41d8f.js"></script><script src="/scripts/main-398d21b2c9.js"></script><script>hljs.initHighlightingOnLoad();</script></body></html>